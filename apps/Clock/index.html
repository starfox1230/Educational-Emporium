<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Time Progress App with Persistent Rainbow Background</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* Fullscreen, transparent body background */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: transparent;
      font-family: Arial, sans-serif;
      color: #fff;
    }
    /* Vanta.js background container */
    #vanta-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -9999;
    }
    /* Main content container */
    .container {
      position: relative;
      z-index: 1;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    /* Progress bar container */
    .progress-container {
      position: absolute;
      top: 20px;
      width: 90%;
      height: 20px;
      background-color: rgba(51, 51, 51, 0.8);
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #00aaff, #ffaa00);
      transition: width 1s linear;
    }
    /* Target time display: right-justified under progress bar with shadowed background */
    .target-display {
      position: absolute;
      top: 50px;
      right: 5%;
      font-size: 24px;
      padding: 4px 8px;
      background-color: rgba(0, 0, 0, 0.6);
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
    }
    /* Digital clock styling with hazy text-shadow for enhanced readability */
    .clock {
      font-size: 80px;
      letter-spacing: 5px;
      margin-top: 60px; /* space for progress and target text */
      text-shadow: 
        0 0 10px rgba(0, 0, 0, 0.8),
        0 0 20px rgba(0, 0, 0, 0.7),
        0 0 30px rgba(0, 0, 0, 0.6);
    }
    /* Time picker styling */
    .target-picker {
      position: absolute;
      bottom: 40px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    button {
      padding: 8px 16px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #00aaff;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background-color: #0088cc;
    }
    /* Flash animation when target time is reached */
    .time-reached {
      animation: flash 1s ease-out;
    }
    @keyframes flash {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- Vanta.js background container -->
  <div id="vanta-bg"></div>
  
  <!-- Main content container -->
  <div class="container">
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="target-display" id="targetDisplay">No target set</div>
    <div class="clock" id="clock">00:00</div>
    <div class="target-picker">
      <input type="time" id="timeInput">
      <button id="setTargetBtn">Set Target Time</button>
    </div>
  </div>
  
  <!-- Include Three.js and Vanta.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.fog.min.js"></script>
  <script>
    // Global variables for Vanta and rainbow cycle control
    let rainbowCycleActive = false;
    let rainbowCycleId = null;

    // Default Vanta options (dark purple/pink)
    function setDefaultVantaColors() {
      window.vantaEffect.setOptions({
        highlightColor: 0x8e44ad,  // Dark purple (#8e44ad)
        midtoneColor: 0xff69b4,    // Pink (#ff69b4)
        lowlightColor: 0x8e44ad,   // Dark purple
        baseColor: 0x000000        // Black
      });
    }

    // Initialize Vanta.FOG with default colors
    window.vantaEffect = VANTA.FOG({
      el: "#vanta-bg",
      mouseControls: true,
      touchControls: true,
      gyroControls: false,
      highlightColor: 0x8e44ad,
      midtoneColor: 0xff69b4,
      lowlightColor: 0x8e44ad,
      baseColor: 0x000000,
      blurFactor: 0.5,
      speed: 0.75,
      zoom: 1.0
    });

    // Resize listener for Vanta effect
    window.addEventListener('resize', function() {
      if (window.vantaEffect && typeof window.vantaEffect.resize === "function") {
        window.vantaEffect.resize();
      }
    });

    // Clock functionality variables
    let targetTime = null;
    let startTime = null;

    // Update clock and progress bar every second
    function updateClock() {
      const now = new Date();
      const clockEl = document.getElementById("clock");
      clockEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      if (targetTime && startTime) {
        const totalDuration = targetTime - startTime;
        const elapsed = now - startTime;
        const progressPercent = Math.min((elapsed / totalDuration) * 100, 100);
        document.getElementById("progressBar").style.width = progressPercent + "%";
        if (elapsed >= totalDuration) {
          triggerTargetReached();
        }
      }
    }
    
    // Sine-wave based function to compute a color (number) from time and phase.
    function cycleColor(time, phase) {
      const frequency = 0.002; // adjust to change cycling speed
      const r = Math.floor(Math.sin(frequency * time + phase) * 127 + 128);
      const g = Math.floor(Math.sin(frequency * time + phase + 2) * 127 + 128);
      const b = Math.floor(Math.sin(frequency * time + phase + 4) * 127 + 128);
      return (r << 16) | (g << 8) | b;
    }
    
    // Start rainbow cycle animation loop
    function startRainbowCycle() {
      rainbowCycleActive = true;
      let startCycleTime = Date.now();
      function cycle() {
        if (!rainbowCycleActive) return;
        const t = Date.now() - startCycleTime;
        window.vantaEffect.setOptions({
          highlightColor: cycleColor(t, 0),
          midtoneColor: cycleColor(t, 2),
          lowlightColor: cycleColor(t, 4),
          baseColor: cycleColor(t, 6)
        });
        rainbowCycleId = requestAnimationFrame(cycle);
      }
      cycle();
    }
    
    // Stop rainbow cycle (if active)
    function stopRainbowCycle() {
      rainbowCycleActive = false;
      if (rainbowCycleId !== null) {
        cancelAnimationFrame(rainbowCycleId);
        rainbowCycleId = null;
      }
      // Reset background to default colors
      setDefaultVantaColors();
    }
    
    // Trigger when target time is reached: flash clock and start persistent rainbow cycle.
    function triggerTargetReached() {
      const clockEl = document.getElementById("clock");
      clockEl.classList.add("time-reached");
      
      // Start rainbow cycle; this will persist until a new target time is chosen.
      startRainbowCycle();
      
      // Flash animation, then clear target time (but keep rainbow active)
      setTimeout(() => {
        clockEl.classList.remove("time-reached");
        targetTime = null;
        startTime = null;
        document.getElementById("progressBar").style.width = "0%";
        document.getElementById("timeInput").value = "";
      }, 1000);
    }
    
    // Set new target time. If a rainbow cycle is active, stop it.
    function setTargetTime() {
      if (rainbowCycleActive) {
        stopRainbowCycle();
      }
      const timeInput = document.getElementById("timeInput").value;
      if (!timeInput) return;
      const now = new Date();
      const [inputHours, inputMinutes] = timeInput.split(":").map(Number);
      let newTarget = new Date(now.getFullYear(), now.getMonth(), now.getDate(), inputHours, inputMinutes);
      if (newTarget <= now) {
        newTarget.setDate(newTarget.getDate() + 1);
      }
      targetTime = newTarget;
      startTime = now;
      const options = { hour: '2-digit', minute: '2-digit' };
      // Now only the time is displayed (no "Target Time:" prefix)
      document.getElementById("targetDisplay").textContent = targetTime.toLocaleTimeString([], options);
    }
    
    document.getElementById("setTargetBtn").addEventListener("click", setTargetTime);
    updateClock();
    setInterval(updateClock, 1000);
  </script>
</body>
</html>
