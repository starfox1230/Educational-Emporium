<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shape Spin Quiz (3D)</title>
  <style>
    :root{
      --bg0:#070A12; --bg1:#0C1230;
      --text:#EAF0FF; --muted:#A9B6E6;
      --good:#2EE59D; --bad:#FF4D6D;
      --accent:#7C5CFF; --accent2:#22D3EE;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --softShadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 22px; --ring: 0 0 0 3px rgba(124,92,255,.28); --ring2: 0 0 0 3px rgba(34,211,238,.25);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(124,92,255,.30), transparent 60%),
        radial-gradient(1000px 600px at 80% 30%, rgba(34,211,238,.22), transparent 55%),
        radial-gradient(800px 500px at 60% 90%, rgba(46,229,157,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px 28px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 45%),
        linear-gradient(135deg, rgba(124,92,255,.95), rgba(34,211,238,.85));
      box-shadow: var(--softShadow);
      position:relative;
      flex:0 0 auto;
    }
    .logo:after{content:"";position:absolute;inset:10px;border-radius:10px;border:1.5px solid rgba(255,255,255,.28);transform: rotate(12deg)}
    .titleBlock{min-width:0}
    h1{font-size:18px;margin:0;letter-spacing:.2px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{margin:4px 0 0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .topStats{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 8px 18px rgba(0,0,0,.2);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      font-size:13px;
    }
    .pill b{font-variant-numeric: tabular-nums}
    .dot{width:10px;height:10px;border-radius:50%;background: rgba(255,255,255,.4);box-shadow: 0 0 0 3px rgba(255,255,255,.08)}
    .dot.good{background: var(--good); box-shadow: 0 0 0 3px rgba(46,229,157,.16)}
    .dot.accent{background: var(--accent2); box-shadow: 0 0 0 3px rgba(34,211,238,.15)}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:14px}
    @media (max-width: 920px){.grid{grid-template-columns:1fr}}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:""; position:absolute; inset:-2px;
      background: radial-gradient(600px 250px at 20% 0%, rgba(124,92,255,.22), transparent 60%),
                  radial-gradient(600px 250px at 85% 20%, rgba(34,211,238,.18), transparent 60%);
      pointer-events:none; opacity:.9;
    }
    .viewerHeader{position:relative;padding:14px 16px 10px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .viewerHeader .label{display:flex;flex-direction:column;gap:4px;min-width:0}
    .viewerHeader .label .big{font-size:14px;font-weight:700}
    .viewerHeader .label .small{font-size:12px;color:var(--muted)}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.14);
      background: rgba(15,25,60,.55);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(18,30,74,.70)}
    .btn:active{transform: translateY(0px) scale(.99)}
    .btn:focus{outline:none; box-shadow: var(--softShadow), var(--ring)}
    .btn.secondary{background: rgba(12,18,48,.45)}
    .btn.secondary:focus{box-shadow: var(--softShadow), var(--ring2)}
    .btn.tiny{padding:8px 10px; border-radius:12px; font-size:12px}

    .viewer{
      position:relative;
      height: 460px;
      background:
        radial-gradient(900px 400px at 30% 10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(700px 380px at 70% 30%, rgba(124,92,255,.14), transparent 60%),
        radial-gradient(600px 320px at 60% 80%, rgba(34,211,238,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.35));
      border-top:1px solid rgba(255,255,255,.10);
      border-bottom:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      touch-action: none;
    }
    @media (max-width: 920px){ .viewer{height: 380px;} }

    .hintBar{position:absolute;left:12px;right:12px;bottom:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center;pointer-events:none}
    .hint{
      font-size:12px;color:rgba(234,240,255,.85);
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;border-radius:999px;
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    }
    .toast{
      position:absolute;top:12px;left:50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.38);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;border-radius:999px;
      font-size:13px;color:rgba(255,255,255,.92);
      box-shadow: 0 10px 26px rgba(0,0,0,.28);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      opacity:0;
      transition: opacity .22s ease, transform .22s ease;
      pointer-events:none;
      white-space:nowrap;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(0)}
    .toast.good{border-color: rgba(46,229,157,.35)}
    .toast.bad{border-color: rgba(255,77,109,.35)}

    .errorBox{
      position:absolute; inset:14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      text-align:center;
      color: rgba(234,240,255,.92);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .errorBox.show{display:flex;}
    .errorBox b{display:block;margin-bottom:6px}
    .errorBox .small{color: rgba(234,240,255,.78); font-size:12px; line-height:1.4}

    .rightCard{padding:14px 14px 14px;position:relative}
    .questionTitle{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px}
    .questionTitle h2{margin:0;font-size:16px;line-height:1.2}
    .round{display:flex;flex-direction:column;align-items:flex-end;gap:4px;color:var(--muted);font-size:12px}
    .bar{height:10px;border-radius:999px;background: rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);overflow:hidden}
    .bar>i{display:block;height:100%;width:0%;background: linear-gradient(90deg, rgba(124,92,255,.95), rgba(34,211,238,.9));border-radius:999px;transition: width .22s ease}

    .choices{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .choice{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 12px;border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(12,18,48,.35);
      cursor:pointer;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      user-select:none;
    }
    .choice:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.22); background: rgba(16,27,68,.48)}
    .choice[aria-disabled="true"]{opacity:.65; cursor:not-allowed}
    .choice .left{display:flex;align-items:center;gap:10px;min-width:0}
    .kbd{
      width:30px;height:30px;border-radius:10px;display:grid;place-items:center;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      font-weight:900;font-size:12px;color: rgba(234,240,255,.9);
      flex:0 0 auto;
    }
    .choice span{font-size:14px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .badge{font-size:11px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.18)}
    .choice.correct{border-color: rgba(46,229,157,.55);background: rgba(46,229,157,.10);box-shadow: 0 0 0 3px rgba(46,229,157,.14) inset}
    .choice.wrong{border-color: rgba(255,77,109,.55);background: rgba(255,77,109,.09);box-shadow: 0 0 0 3px rgba(255,77,109,.12) inset}

    .mini{margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .miniCard{border-radius: 18px;background: rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);padding:12px;box-shadow: 0 10px 26px rgba(0,0,0,.22)}
    .miniCard .k{font-size:12px;color:var(--muted);margin-bottom:6px}
    .miniCard .v{font-size:22px;font-weight:950;font-variant-numeric: tabular-nums}
    .miniCard .v small{font-size:12px;font-weight:900;color:rgba(234,240,255,.85)}

    .footerRow{margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .toggleRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .toggle{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius: 16px;border:1px solid rgba(255,255,255,.12);background: rgba(12,18,48,.35)}
    .toggle input{width:18px;height:18px;accent-color: var(--accent);cursor:pointer}
    .toggle label{cursor:pointer;font-weight:800;color: rgba(234,240,255,.92)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="titleBlock">
          <h1>Shape Spin Quiz</h1>
          <div class="sub">Drag to rotate the 3D shape. Pick the correct name.</div>
        </div>
      </div>
      <div class="topStats">
        <div class="pill"><span class="dot accent"></span><span>Points: <b id="pointsTop">0</b></span></div>
        <div class="pill"><span class="dot good"></span><span>Streak: <b id="streakTop">0</b></span></div>
        <div class="pill"><span class="dot"></span><span>Best: <b id="bestTop">0</b></span></div>
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <div class="viewerHeader">
          <div class="label">
            <div class="big">3D Shape Viewer</div>
            <div class="small">Scroll to zoom. Right-drag to pan.</div>
          </div>
          <div class="btnRow">
            <button class="btn tiny secondary" id="btnSpeak" type="button">üîä Speak</button>
            <button class="btn tiny secondary" id="btnShuffle" type="button">‚Üª New</button>
          </div>
        </div>

        <div class="viewer" id="viewer">
          <div class="toast" id="toast" aria-live="polite"></div>
          <div class="errorBox" id="errorBox">
            <div>
              <b>3D failed to load</b>
              <div class="small" id="errorText">If you see this, your browser blocked loading Three.js or WebGL is unavailable.</div>
            </div>
          </div>
          <div class="hintBar" aria-hidden="true">
            <div class="hint">üñ±Ô∏è Drag to spin</div>
            <div class="hint">üîç Scroll to zoom</div>
          </div>
        </div>
      </section>

      <section class="card rightCard">
        <div class="questionTitle">
          <div>
            <h2>What shape is this?</h2>
            <div style="margin-top:6px; color: var(--muted); font-size:12px;">
              Use keys <b>1</b>, <b>2</b>, <b>3</b>, <b>4</b> to select.
            </div>
          </div>
          <div class="round">
            <div>Round <b id="roundNum">1</b></div>
            <div class="bar" style="width:140px;"><i id="progressFill"></i></div>
          </div>
        </div>

        <div class="choices" id="choices"></div>

        <div class="mini">
          <div class="miniCard"><div class="k">Points</div><div class="v"><span id="points">0</span> <small>pts</small></div></div>
          <div class="miniCard"><div class="k">Streak</div><div class="v"><span id="streak">0</span> <small>in a row</small></div></div>
          <div class="miniCard"><div class="k">Accuracy</div><div class="v"><span id="acc">0</span><small>%</small></div></div>
          <div class="miniCard"><div class="k">Level</div><div class="v"><span id="level">1</span> <small id="levelLabel">Rookie</small></div></div>
        </div>

        <div class="footerRow">
          <div class="toggleRow">
            <div class="toggle"><input id="toggleBasic" type="checkbox" checked /><label for="toggleBasic">Basic shapes</label></div>
            <div class="toggle"><input id="toggleExtra" type="checkbox" checked /><label for="toggleExtra">Extra shapes</label></div>
            <div class="toggle"><input id="toggleTTS" type="checkbox" checked /><label for="toggleTTS">TTS on answers</label></div>
          </div>
          <div><span style="opacity:.9">Saved locally</span> ‚Ä¢ <button class="btn tiny secondary" id="btnReset" type="button">Reset</button></div>
        </div>
      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.147.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.147.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    (function () {
      const BASIC = [
        { key: "cube", label: "Cube" },
        { key: "sphere", label: "Sphere" },
        { key: "cylinder", label: "Cylinder" },
        { key: "cone", label: "Cone" },
      ];
      const EXTRA = [
        { key: "rectPrism", label: "Rectangular Prism" },
        { key: "triPrism", label: "Triangular Prism" },
        { key: "pyramid", label: "Pyramid" },
        { key: "torus", label: "Torus (Donut)" },
      ];
      const LEVELS = [
        { min: 0, name: "Rookie" },
        { min: 50, name: "Spinner" },
        { min: 120, name: "Shape Star" },
        { min: 220, name: "Geometry Wizard" },
        { min: 360, name: "Legend" },
      ];

      const LS_KEY = "shapeSpinQuiz.v1";

      const el = {
        viewer: q("#viewer"),
        choices: q("#choices"),
        toast: q("#toast"),
        errorBox: q("#errorBox"),
        errorText: q("#errorText"),

        pointsTop: q("#pointsTop"),
        streakTop: q("#streakTop"),
        bestTop: q("#bestTop"),
        points: q("#points"),
        streak: q("#streak"),
        acc: q("#acc"),
        level: q("#level"),
        levelLabel: q("#levelLabel"),
        roundNum: q("#roundNum"),
        progressFill: q("#progressFill"),

        toggleBasic: q("#toggleBasic"),
        toggleExtra: q("#toggleExtra"),
        toggleTTS: q("#toggleTTS"),

        btnShuffle: q("#btnShuffle"),
        btnSpeak: q("#btnSpeak"),
        btnReset: q("#btnReset"),
      };

      // If scripts didn't load
      if (!window.THREE || !THREE.WebGLRenderer || !THREE.OrbitControls) {
        showError("Three.js or OrbitControls did not load. Check that the CDN files are reachable from your network.");
        return;
      }

      // WebGL support check
      if (!isWebGLAvailable()) {
        showError("WebGL is not available in this browser/device.");
        return;
      }

      const state = loadState() || {
        points: 0, streak: 0, best: 0, correct: 0, total: 0, round: 1,
        settings: { basic: true, extra: true, tts: true }
      };

      el.toggleBasic.checked = !!state.settings.basic;
      el.toggleExtra.checked = !!state.settings.extra;
      el.toggleTTS.checked = !!state.settings.tts;

      // --- Three.js setup ---
      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
      el.viewer.appendChild(renderer.domElement);

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
      camera.position.set(2.6, 1.6, 3.0);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.06;
      controls.rotateSpeed = 0.65;
      controls.zoomSpeed = 0.85;
      controls.panSpeed = 0.65;
      controls.minDistance = 1.6;
      controls.maxDistance = 7.5;

      scene.add(new THREE.HemisphereLight(0x9bb8ff, 0x1b2140, 0.85));

      const keyLight = new THREE.DirectionalLight(0xffffff, 1.1);
      keyLight.position.set(4, 5, 3);
      scene.add(keyLight);

      const rimLight = new THREE.DirectionalLight(0x88f7ff, 0.6);
      rimLight.position.set(-5, 2, -3);
      scene.add(rimLight);

      const ground = new THREE.Mesh(
        new THREE.CircleGeometry(2.2, 64),
        new THREE.MeshBasicMaterial({ color: 0x6c63ff, transparent: true, opacity: 0.08 })
      );
      ground.rotation.x = -Math.PI / 2;
      ground.position.y = -0.9;
      scene.add(ground);

      let currentMesh = null;
      let currentAnswer = null;
      let locked = false;

      const edgeMat = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.22 });

      function resize() {
        const r = el.viewer.getBoundingClientRect();
        const w = Math.max(1, r.width);
        const h = Math.max(1, r.height);
        renderer.setSize(w, h, false);
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
      }
      window.addEventListener("resize", resize, { passive: true });
      resize();

      function buildShape(key) {
        if (currentMesh) {
          scene.remove(currentMesh);
          currentMesh.traverse(obj => {
            if (obj.geometry) obj.geometry.dispose();
            if (obj.material) {
              if (Array.isArray(obj.material)) obj.material.forEach(m => m.dispose());
              else obj.material.dispose();
            }
          });
        }

        const group = new THREE.Group();

        const mat = new THREE.MeshStandardMaterial({
          color: new THREE.Color().setHSL(Math.random() * 0.15 + 0.62, 0.75, 0.60),
          metalness: 0.35,
          roughness: 0.22,
          emissive: new THREE.Color(0x0b0f24),
        });

        let geom;
        switch (key) {
          case "cube":      geom = new THREE.BoxGeometry(1.35, 1.35, 1.35); break;
          case "rectPrism": geom = new THREE.BoxGeometry(1.65, 1.05, 1.25); break;
          case "sphere":    geom = new THREE.SphereGeometry(0.92, 48, 28); break;
          case "cylinder":  geom = new THREE.CylinderGeometry(0.75, 0.75, 1.55, 44, 1); break;
          case "cone":      geom = new THREE.ConeGeometry(0.85, 1.75, 44, 1); break;
          case "pyramid":   geom = new THREE.ConeGeometry(0.95, 1.65, 4, 1); break; // square pyramid
          case "triPrism":  geom = triangularPrismGeometry(); break;
          case "torus":     geom = new THREE.TorusGeometry(0.82, 0.30, 28, 70); break;
          default:          geom = new THREE.BoxGeometry(1.35, 1.35, 1.35);
        }

        const mesh = new THREE.Mesh(geom, mat);
        const edges = new THREE.EdgesGeometry(geom, 25);
        const line = new THREE.LineSegments(edges, edgeMat);

        group.add(mesh);
        group.add(line);

        group.position.y = -0.05;

        controls.target.set(0, 0, 0);
        controls.update();

        scene.add(group);
        currentMesh = group;
      }

      function triangularPrismGeometry() {
        const shape = new THREE.Shape();
        shape.moveTo(-0.8, -0.55);
        shape.lineTo(0.8, -0.55);
        shape.lineTo(0, 0.85);
        shape.lineTo(-0.8, -0.55);

        const g = new THREE.ExtrudeGeometry(shape, {
          depth: 1.15,
          bevelEnabled: true,
          bevelThickness: 0.06,
          bevelSize: 0.06,
          bevelSegments: 2,
          steps: 1
        });
        g.center();
        return g;
      }

      function getPool() {
        const pool = [];
        if (el.toggleBasic.checked) pool.push(...BASIC);
        if (el.toggleExtra.checked) pool.push(...EXTRA);
        if (pool.length === 0) pool.push(...BASIC);
        return pool;
      }

      function pickNewQuestion() {
        locked = false;
        const pool = getPool();
        const correct = pool[Math.floor(Math.random() * pool.length)];
        currentAnswer = correct;
        buildShape(correct.key);
        renderChoices(correct, pool);
        showToast("Spin it, then pick the name!", "neutral");
        updateUI();
        persist();
      }

      function renderChoices(correct, pool) {
        const distractors = pool.filter(s => s.key !== correct.key);
        shuffleInPlace(distractors);
        const options = [correct, ...distractors.slice(0, 3)];
        shuffleInPlace(options);

        el.choices.innerHTML = "";
        options.forEach((opt, idx) => {
          const btn = document.createElement("button");
          btn.className = "choice";
          btn.type = "button";
          btn.setAttribute("data-key", opt.key);
          btn.innerHTML = `
            <div class="left">
              <div class="kbd" aria-hidden="true">${idx + 1}</div>
              <span>${opt.label}</span>
            </div>
            <div class="badge" aria-hidden="true">Tap</div>
          `;
          btn.addEventListener("click", () => handleAnswer(opt.key), { passive: true });
          el.choices.appendChild(btn);
        });
      }

      function handleAnswer(key) {
        if (locked) return;
        locked = true;

        [...el.choices.querySelectorAll(".choice")].forEach(b => b.setAttribute("aria-disabled", "true"));

        state.total += 1;
        const correctKey = currentAnswer.key;
        const wasCorrect = key === correctKey;

        [...el.choices.querySelectorAll(".choice")].forEach(b => {
          const k = b.getAttribute("data-key");
          if (k === correctKey) b.classList.add("correct");
          if (k === key && !wasCorrect) b.classList.add("wrong");
        });

        if (wasCorrect) {
          state.correct += 1;
          state.streak += 1;
          state.best = Math.max(state.best, state.streak);

          const bonus = Math.min(10, state.streak);
          const gained = 10 + bonus;
          state.points += gained;

          showToast(`‚úÖ Correct! +${gained} points`, "good");
          speakMaybe(currentAnswer.label);
        } else {
          state.streak = 0;
          showToast(`‚ùå Oops ‚Äî it was ${currentAnswer.label}`, "bad");
          speakMaybe(`It was ${currentAnswer.label}`);
        }

        state.round += 1;
        updateUI();
        persist();
        setTimeout(pickNewQuestion, 950);
      }

      function updateUI() {
        el.points.textContent = state.points;
        el.streak.textContent = state.streak;
        el.pointsTop.textContent = state.points;
        el.streakTop.textContent = state.streak;
        el.bestTop.textContent = state.best;

        const acc = state.total ? Math.round((state.correct / state.total) * 100) : 0;
        el.acc.textContent = acc;

        const level = calcLevel(state.points);
        el.level.textContent = level.idx + 1;
        el.levelLabel.textContent = level.name;

        el.roundNum.textContent = state.round;

        const loop = (state.round - 1) % 10;
        el.progressFill.style.width = Math.round((loop / 10) * 100) + "%";
      }

      function calcLevel(points) {
        let idx = 0;
        for (let i = 0; i < LEVELS.length; i++) if (points >= LEVELS[i].min) idx = i;
        return { idx, name: LEVELS[idx].name };
      }

      let toastTimer = null;
      function showToast(msg, kind) {
        el.toast.textContent = msg;
        el.toast.classList.remove("good", "bad", "show");
        if (kind === "good") el.toast.classList.add("good");
        if (kind === "bad") el.toast.classList.add("bad");
        requestAnimationFrame(() => el.toast.classList.add("show"));
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => el.toast.classList.remove("show"), 1200);
      }

      function speakMaybe(text) {
        if (!el.toggleTTS.checked) return;
        try { window.speechSynthesis.cancel(); } catch {}
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1.0; u.pitch = 1.05; u.volume = 1.0;
        window.speechSynthesis.speak(u);
      }

      function persist() {
        const payload = {
          points: state.points, streak: state.streak, best: state.best,
          correct: state.correct, total: state.total, round: state.round,
          settings: {
            basic: el.toggleBasic.checked,
            extra: el.toggleExtra.checked,
            tts: el.toggleTTS.checked
          }
        };
        try { localStorage.setItem(LS_KEY, JSON.stringify(payload)); } catch {}
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(LS_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch { return null; }
      }

      function shuffleInPlace(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      function q(sel) { return document.querySelector(sel); }

      function isWebGLAvailable() {
        try {
          const canvas = document.createElement("canvas");
          return !!(window.WebGLRenderingContext &&
            (canvas.getContext("webgl") || canvas.getContext("experimental-webgl")));
        } catch { return false; }
      }

      function showError(message) {
        el.errorText.textContent = message;
        el.errorBox.classList.add("show");
      }

      // UI wiring
      el.btnShuffle.addEventListener("click", () => pickNewQuestion());
      el.btnSpeak.addEventListener("click", () => currentAnswer && speakMaybe(currentAnswer.label));

      el.toggleBasic.addEventListener("change", () => { state.settings.basic = el.toggleBasic.checked; persist(); pickNewQuestion(); });
      el.toggleExtra.addEventListener("change", () => { state.settings.extra = el.toggleExtra.checked; persist(); pickNewQuestion(); });
      el.toggleTTS.addEventListener("change", () => { state.settings.tts = el.toggleTTS.checked; persist(); });

      el.btnReset.addEventListener("click", () => {
        state.points = 0; state.streak = 0; state.best = 0;
        state.correct = 0; state.total = 0; state.round = 1;
        persist(); updateUI(); pickNewQuestion();
      });

      window.addEventListener("keydown", (e) => {
        if (["1","2","3","4"].includes(e.key)) {
          const idx = parseInt(e.key, 10) - 1;
          const btns = [...el.choices.querySelectorAll(".choice")];
          if (btns[idx] && btns[idx].getAttribute("aria-disabled") !== "true") btns[idx].click();
        }
        if (e.key.toLowerCase() === "n") el.btnShuffle.click();
        if (e.key.toLowerCase() === "s") el.btnSpeak.click();
      });

      // Animate
      let t = 0;
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        if (currentMesh) {
          t += 0.012;
          currentMesh.position.y = -0.05 + Math.sin(t) * 0.06;
          currentMesh.rotation.y += 0.002;
        }
        renderer.render(scene, camera);
      }
      animate();

      // Start
      updateUI();
      pickNewQuestion();

    })();
  </script>
</body>
</html>
