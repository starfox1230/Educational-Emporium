<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lesson 5: Position Words</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root {
            --bg-color: #f0f8ff;
            --main-green: #a7c957;
            --river-color: #48cae4;
            --button-bg: #ffbe0b;
            --button-hover: #fb5607;
            --correct-color: #4CAF50;
            --incorrect-color: #F44336;
            --highlight-color: #ffc300;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes pulse {
            0% { filter: drop-shadow(0 0 0px var(--highlight-color)); }
            50% { filter: drop-shadow(0 0 20px var(--highlight-color)); }
            100% { filter: drop-shadow(0 0 0px var(--highlight-color)); }
        }

        body {
            font-family: 'Arial Rounded MT Bold', 'Helvetica Rounded', Arial, sans-serif;
            margin: 0; padding: 0; background-color: #333; overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
        }

        #game-container {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-color); display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }

        #visual-area {
            flex-grow: 1; width: 100%; position: relative; overflow: hidden;
        }
        
        .scene {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in-out, visibility 0.5s;
        }
        .scene.active { opacity: 1; visibility: visible; }

        .svg-content { width: 100%; height: 100%; }

        /* Map Styles */
        #map-scene { background-color: var(--main-green); }
        .clickable-area-shape { cursor: pointer; fill: rgba(255, 255, 255, 0.01); stroke: none; }
        .clickable-area-shape.highlight { animation: pulse 1.5s infinite ease-in-out; }
        .clickable-area-shape.correct { stroke: var(--correct-color); stroke-width: 8; fill: rgba(76, 175, 80, 0.3); }
        .clickable-area-shape.incorrect { stroke: var(--incorrect-color); stroke-width: 8; fill: rgba(244, 67, 54, 0.3); animation: shake 0.4s ease; }
        #car { position: absolute; width: 60px; height: 30px; transform-origin: center center; transition: all 1.5s cubic-bezier(0.45, 0, 0.55, 1); }

        /* Tracing Styles */
        #tracing-scene { background-color: #ade8f4; }
        .trace-target-shape { cursor: pointer; fill: transparent; }
        .trace-target-shape:hover, .trace-target-shape.highlight { fill: rgba(255, 190, 11, 0.4); animation: pulse 1.5s infinite ease-in-out alternate; }
        
        #canvas-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center; flex-direction: column; z-index: 100;
        }
        #canvas-container.hidden { display: none; }
        #drawing-canvas { background: white; border-radius: 15px; box-shadow: 0 0 20px rgba(255,255,255,0.5); max-width: 90vw; max-height: 70vh; }
        #canvas-controls { margin-top: 15px; }

        /* UI Panel */
        #ui-panel {
            flex-shrink: 0; width: 100%; padding: 10px; text-align: center; background-color: #bde0fe;
            border-top: 5px solid #a2d2ff; height: 100px; box-sizing: border-box; display: flex;
            justify-content: space-between; align-items: center;
        }
        #message-area { flex-grow: 1; font-size: clamp(1rem, 4vw, 1.5rem); font-weight: bold; padding: 0 10px; }
        
        button, #speaker-btn {
            padding: 10px 20px; font-size: clamp(1rem, 4vw, 1.2rem); font-weight: bold; font-family: inherit;
            color: #333; background-color: var(--button-bg); border: none; border-radius: 10px; cursor: pointer;
            box-shadow: 0 4px 0px #e85d04; transition: all 0.1s ease-in-out; margin: 0 5px;
        }
        button:hover, button:focus, #speaker-btn:hover, #speaker-btn:focus { background-color: var(--button-hover); color: white; box-shadow: 0 4px 0px #d00000; outline: none; }
        button:active, #speaker-btn:active { transform: translateY(2px); box-shadow: 0 2px 0px #d00000; }
        
        #speaker-btn { width: 60px; height: 60px; padding: 0; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        #speaker-btn svg { width: 50%; height: 50%; fill: currentColor; }
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div id="game-container">
        <div id="visual-area">
            
            <div id="map-scene" class="scene">
                <svg class="svg-content" viewBox="0 0 900 620" preserveAspectRatio="xMidYMid meet">
                    <!-- Path -->
                    <path d="M 50 150 C 150 100, 250 200, 350 150 S 450 100, 550 150 S 650 250, 750 200 L 850 200" stroke="#f2e8cf" stroke-width="60" fill="none" stroke-linecap="round"/>
                    <!-- River -->
                    <path d="M 450 0 C 350 100, 500 250, 450 350 C 400 450, 250 500, 200 620" stroke="#48cae4" stroke-width="50" fill="none" stroke-linecap="round"/>
                    <path d="M 650 620 C 750 500, 600 400, 650 300 C 700 200, 850 150, 900 100" stroke="#48cae4" stroke-width="50" fill="none" stroke-linecap="round"/>
                    <!-- Pond -->
                    <g id="pond-clickable" class="clickable-area"><ellipse cx="150" cy="400" rx="100" ry="60" class="clickable-area-shape"/><ellipse cx="150" cy="400" rx="100" ry="60" fill="#00b4d8"/></g>
                    <!-- Trees -->
                    <g id="tree1-clickable" class="clickable-area"><rect x="250" y="480" width="80" height="120" class="clickable-area-shape"/><rect x="280" y="550" width="20" height="50" fill="#7f5539"/><circle cx="290" cy="520" r="40" fill="#386641"/></g>
                    <!-- Bridges -->
                    <g id="bridge2-clickable" class="clickable-area"><rect x="425" y="10" width="50" height="130" transform="rotate(30 450 75)" class="clickable-area-shape"/><rect x="425" y="10" width="50" height="130" fill="#c27721" stroke="#874f10" stroke-width="4" transform="rotate(30 450 75)"/><text x="450" y="85" font-size="40" fill="white" text-anchor="middle" dominant-baseline="middle" style="pointer-events: none;">2</text></g>
                    <g id="bridge3-clickable" class="clickable-area"><rect x="625" y="400" width="130" height="50" transform="rotate(-20 690 425)" class="clickable-area-shape"/><rect x="625" y="400" width="130" height="50" fill="#c27721" stroke="#874f10" stroke-width="4" transform="rotate(-20 690 425)"/><text x="690" y="430" font-size="40" fill="white" text-anchor="middle" dominant-baseline="middle" style="pointer-events: none;">3</text></g>
                    <g id="bridge4-clickable" class="clickable-area"><rect x="730" y="200" width="130" height="50" transform="rotate(45 795 225)" class="clickable-area-shape"/><rect x="730" y="200" width="130" height="50" fill="#c27721" stroke="#874f10" stroke-width="4" transform="rotate(45 795 225)"/><text x="795" y="230" font-size="40" fill="white" text-anchor="middle" dominant-baseline="middle" style="pointer-events: none;">4</text></g>
                    <g id="bridge5-clickable" class="clickable-area"><rect x="200" y="250" width="50" height="130" transform="rotate(-25 225 315)" class="clickable-area-shape"/><rect x="200" y="250" width="50" height="130" fill="#c27721" stroke="#874f10" stroke-width="4" transform="rotate(-25 225 315)"/><text x="225" y="320" font-size="40" fill="white" text-anchor="middle" dominant-baseline="middle" style="pointer-events: none;">5</text></g>
                    <!-- Start Sign -->
                    <g id="start-clickable" class="clickable-area"><polygon points="20,110 120,110 140,130 120,150 20,150 0,130" class="clickable-area-shape"/><rect x="65" y="150" width="10" height="30" fill="#6c757d"/><polygon points="20,110 120,110 140,130 120,150 20,150 0,130" fill="#fca311"/><text x="70" y="133" font-size="20" fill="black" text-anchor="middle" font-weight="bold" style="pointer-events: none;">Start</text></g>
                </svg>
                <div id="car">
                    <svg viewBox="0 0 100 50"><path d="M 10 30 C 0 30, 0 40, 10 40 L 90 40 C 100 40, 100 30, 90 30 L 70 30 L 60 10 L 30 10 L 20 30 Z" fill="#d00000" stroke="black" stroke-width="2"/><rect x="30" y="15" width="30" height="15" fill="#ade8f4" stroke="black" stroke-width="2"/><circle cx="25" cy="40" r="8" fill="#343a40" stroke="black" stroke-width="1"/><circle cx="75" cy="40" r="8" fill="#343a40" stroke="black" stroke-width="1"/></svg>
                </div>
            </div>

            <div id="tracing-scene" class="scene">
                <svg class="svg-content" viewBox="0 0 900 620" preserveAspectRatio="xMidYMid meet">
                    <!-- Frog -->
                    <g><ellipse cx="650" cy="450" rx="150" ry="70" fill="#4c956c"/><path d="M 650 380 C 600 350, 700 350, 700 380 C 720 420, 680 440, 650 430 C 620 440, 580 420, 600 380 Z" fill="#52b788"/><circle cx="620" cy="370" r="20" fill="white"/><circle cx="620" cy="370" r="10" fill="black"/><circle cx="680" cy="370" r="20" fill="white"/><circle cx="680" cy="370" r="10" fill="black"/></g>
                    <!-- Butterfly on Flower -->
                    <g><line x1="250" y1="620" x2="250" y2="350" stroke="#55a630" stroke-width="10" /><circle cx="250" cy="350" r="30" fill="#ffc300"/><path d="M250,350 L200,300 A50,50 0 0,1 250,350Z" fill="#ffc300"/><path d="M250,350 L300,300 A50,50 0 0,0 250,350Z" fill="#ffc300"/><path d="M250,350 L200,400 A50,50 0 0,0 250,350Z" fill="#ffc300"/><path d="M250,350 L300,400 A50,50 0 0,1 250,350Z" fill="#ffc300"/><path d="M 250 200 C 150 150, 150 300, 250 250" fill="#fb5607" stroke="#333" stroke-width="3"/><path d="M 250 200 C 350 150, 350 300, 250 250" fill="#fb5607" stroke="#333" stroke-width="3"/><circle cx="250" cy="250" r="15" fill="#333"/></g>
                    <!-- Numbers & Clickable Targets -->
                    <g id="trace-2-clickable" data-number="2"><rect x="210" y="80" width="80" height="100" class="trace-target-shape"/><text x="250" y="150" font-size="80" text-anchor="middle" fill="#3a86ff" font-weight="bold" style="pointer-events:none;">2</text></g>
                    <g id="trace-3-clickable" data-number="3"><rect x="410" y="250" width="80" height="100" class="trace-target-shape"/><text x="450" y="320" font-size="80" text-anchor="middle" fill="#3a86ff" font-weight="bold" style="pointer-events:none;">3</text></g>
                    <g id="trace-4-clickable" data-number="4"><rect x="780" y="380" width="80" height="100" class="trace-target-shape"/><text x="820" y="450" font-size="80" text-anchor="middle" fill="#3a86ff" font-weight="bold" style="pointer-events:none;">4</text></g>
                    <g id="trace-5-clickable" data-number="5"><rect x="210" y="480" width="80" height="100" class="trace-target-shape"/><text x="250" y="550" font-size="80" text-anchor="middle" fill="#3a86ff" font-weight="bold" style="pointer-events:none;">5</text></g>
                    <g id="trace-1-clickable" data-number="1"><rect x="30" y="180" width="80" height="100" class="trace-target-shape"/><text x="70" y="250" font-size="80" text-anchor="middle" fill="#3a86ff" font-weight="bold" style="pointer-events:none;">1</text></g>
                </svg>
            </div>

            <div id="canvas-container" class="hidden">
                 <canvas id="drawing-canvas" width="400" height="400"></canvas>
                 <div id="canvas-controls">
                     <button id="clear-canvas-btn">Clear</button>
                     <button id="done-tracing-btn">Done</button>
                 </div>
            </div>
        </div>
        <div id="ui-panel">
            <button id="speaker-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></button>
            <div id="message-area"><button id="start-btn">Start Lesson</button></div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const messageArea = document.getElementById('message-area');
        const startBtn = document.getElementById('start-btn');
        const speakerBtn = document.getElementById('speaker-btn');
        const mapScene = document.getElementById('map-scene');
        const tracingScene = document.getElementById('tracing-scene');
        const car = document.getElementById('car');
        const allClickableAreas = document.querySelectorAll('.clickable-area, [id^="trace-"]');
        const traceTargets = document.querySelectorAll('[id^="trace-"]');

        const canvasContainer = document.getElementById('canvas-container');
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const clearCanvasBtn = document.getElementById('clear-canvas-btn');
        const doneTracingBtn = document.getElementById('done-tracing-btn');

        // --- State ---
        let currentInstruction = "";
        let isLessonActive = false;
        let lessonStep = 0;
        let currentGameQuestion = null;
        let currentTraceNumber = null;

        const positions = {
            start: { top: '20%', left: '5%', rot: '0deg' }, bridge2: { top: '10%', left: '48%', rot: '30deg' },
            bridge3: { top: '65%', left: '75%', rot: '-20deg' }, bridge4: { top: '35%', left: '85%', rot: '45deg' },
            bridge5: { top: '45%', left: '20%', rot: '-25deg' }, pond: { top: '55%', left: '15%', rot: '180deg' },
            tree1: { top: '80%', left: '35%', rot: '0deg' },
        };
        
        const lessonPlan = [
            { type: 'map', message: "Place the car ON the Start sign.", target: 'start-clickable' },
            { type: 'map', message: 'Great! Drive OVER bridge number 2.', target: 'bridge2-clickable' },
            { type: 'map', message: 'Good job! Go OVER bridge number 3.', target: 'bridge3-clickable' },
            { type: 'transition', message: "Fantastic driving! Now let's trace some numbers." },
            { type: 'trace', message: 'Trace the number 2 ABOVE the butterfly.', target: 'trace-2-clickable' },
            { type: 'trace', message: 'Trace the number 4 BESIDE the frog.', target: 'trace-4-clickable' },
            { type: 'trace', message: 'Trace the number 1 BESIDE the butterfly.', target: 'trace-1-clickable' },
            { type: 'end', message: "You did it! Let's play a game to practice." },
        ];
        
        const gameQuestions = [
            { instruction: "Drive OVER bridge number 2.", targetId: 'bridge2-clickable' },
            { instruction: "Drive OVER bridge number 3.", targetId: 'bridge3-clickable' },
            { instruction: "Drive OVER bridge number 4.", targetId: 'bridge4-clickable' },
            { instruction: "Drive OVER bridge number 5.", targetId: 'bridge5-clickable' },
            { instruction: "Drive AROUND the pond.", targetId: 'pond-clickable' },
            { instruction: "Park NEXT TO the tree.", targetId: 'tree1-clickable' }
        ];

        const synth = window.speechSynthesis;
        function speak(text) {
            if (!text) return;
            currentInstruction = text;
            if (synth.speaking) synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9; utterance.pitch = 1.1;
            synth.speak(utterance);
        }

        function showMessage(text, showButton = false, buttonText = "Next", onClick = null) {
            messageArea.innerHTML = '';
            const p = document.createElement('p');
            p.textContent = text;
            messageArea.appendChild(p);
            speak(text);
            if (showButton) {
                const btn = document.createElement('button');
                btn.textContent = buttonText; btn.onclick = onClick;
                messageArea.appendChild(btn);
            }
        }

        function switchScene(sceneName) {
            mapScene.classList.toggle('active', sceneName === 'map');
            tracingScene.classList.toggle('active', sceneName === 'trace');
        }

        function resetAllHighlights() {
            allClickableAreas.forEach(area => {
                const shape = area.querySelector('.clickable-area-shape, .trace-target-shape');
                if(shape) shape.classList.remove('highlight', 'correct', 'incorrect');
            });
        }

        function highlightTarget(targetId) {
            resetAllHighlights();
            const targetElement = document.getElementById(targetId);
            if(targetElement) {
                const shape = targetElement.querySelector('.clickable-area-shape, .trace-target-shape');
                if (shape) shape.classList.add('highlight');
            }
        }
        
        function moveCar(targetId) {
            const posId = targetId.replace('-clickable', '');
            const pos = positions[posId];
            if (pos) { car.style.top = pos.top; car.style.left = pos.left; car.style.transform = `rotate(${pos.rot})`; }
        }

        function handleMapAnswer(e) {
            const clickedElement = e.currentTarget;
            const clickedId = clickedElement.id;
            const shape = clickedElement.querySelector('.clickable-area-shape');
            let correctTargetId = isLessonActive ? lessonPlan[lessonStep].target : currentGameQuestion.targetId;

            if (clickedId === correctTargetId) {
                speak("Good job!");
                shape.classList.remove('highlight'); shape.classList.add('correct');
                moveCar(clickedId);
                allClickableAreas.forEach(area => area.onclick = null);
                setTimeout(() => { isLessonActive ? handleLessonStep() : nextQuestion(); }, 2000);
            } else {
                speak("Oops, try again.");
                shape.classList.add('incorrect');
                setTimeout(() => shape.classList.remove('incorrect'), 500);
            }
        }

        function handleTraceAnswer(e) {
            const clickedElement = e.currentTarget;
            const correctTargetId = lessonPlan[lessonStep].target;
            if (clickedElement.id === correctTargetId) {
                const shape = clickedElement.querySelector('.trace-target-shape');
                shape.classList.remove('highlight');
                speak("Okay, trace it!");
                allClickableAreas.forEach(area => area.onclick = null);
                setupCanvasForNumber(clickedElement.dataset.number);
            }
        }
        
        function handleLessonStep() {
            lessonStep++;
            if (lessonStep >= lessonPlan.length) return;
            const step = lessonPlan[lessonStep];
            
            resetAllHighlights();
            showMessage(step.message);

            switch(step.type) {
                case 'map':
                    setupMapListeners(handleMapAnswer);
                    highlightTarget(step.target);
                    break;
                case 'transition':
                    allClickableAreas.forEach(area => area.onclick = null);
                    setTimeout(() => {
                        switchScene('trace');
                        handleLessonStep();
                    }, 2500);
                    break;
                case 'trace':
                    setupTraceListeners(handleTraceAnswer);
                    highlightTarget(step.target);
                    break;
                case 'end':
                    isLessonActive = false;
                    showMessage(step.message, true, "Play Game!", startGame);
                    break;
            }
        }

        function setupMapListeners(handler) { traceTargets.forEach(t => t.onclick=null); document.querySelectorAll('.clickable-area').forEach(a => a.onclick=handler); }
        function setupTraceListeners(handler) { document.querySelectorAll('.clickable-area').forEach(a => a.onclick=null); traceTargets.forEach(t => t.onclick=handler); }
        
        function nextQuestion() {
            const lastQuestion = currentGameQuestion;
            do { currentGameQuestion = gameQuestions[Math.floor(Math.random() * gameQuestions.length)]; } 
            while (gameQuestions.length > 1 && currentGameQuestion === lastQuestion);
            
            showMessage(currentGameQuestion.instruction);
            highlightTarget(currentGameQuestion.targetId);
            setupMapListeners(handleMapAnswer);
        }

        function startLesson() {
            startBtn.classList.add('hidden');
            isLessonActive = true;
            lessonStep = -1; // Start at -1 so first call increments to 0
            handleLessonStep();
        }
        
        function startGame() {
            isLessonActive = false;
            switchScene('map');
            nextQuestion();
        }

        // --- Canvas Logic ---
        let isDrawing = false, lastX = 0, lastY = 0;
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            return { x: (touch.clientX - rect.left) * (canvas.width / rect.width), y: (touch.clientY - rect.top) * (canvas.height / rect.height) };
        }
        function startDrawing(e) { isDrawing = true; const pos = getPos(e); [lastX, lastY] = [pos.x, pos.y]; }
        function draw(e) { if (!isDrawing) return; e.preventDefault(); const pos = getPos(e); ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(pos.x, pos.y); ctx.stroke(); [lastX, lastY] = [pos.x, pos.y]; }
        function stopDrawing() { isDrawing = false; }
        
        function drawNumberGuide(num) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '250px "Arial Rounded MT Bold", sans-serif'; ctx.fillStyle = '#ddd';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            const visualGuideChar = num === '1' ? 'l' : num;
            ctx.fillText(visualGuideChar, canvas.width / 2, canvas.height / 2 + 10);
            ctx.strokeStyle = '#3a86ff'; ctx.lineWidth = 15; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        }

        function setupCanvasForNumber(num) {
            currentTraceNumber = num;
            drawNumberGuide(num);
            canvasContainer.classList.remove('hidden');
        }

        canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing); canvas.addEventListener('mouseleave', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, { passive: false }); canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);
        clearCanvasBtn.addEventListener('click', () => drawNumberGuide(currentTraceNumber));
        doneTracingBtn.addEventListener('click', () => { canvasContainer.classList.add('hidden'); handleLessonStep(); });

        // --- Init ---
        function init() {
            const startPos = positions['start'];
            car.style.top = startPos.top; car.style.left = startPos.left; car.style.transform = `rotate(${startPos.rot})`;
            switchScene('map');
            const welcomeMsg = "Welcome! Press Start Lesson to begin.";
            currentInstruction = welcomeMsg; speak(welcomeMsg);
            startBtn.addEventListener('click', startLesson);
            speakerBtn.addEventListener('click', () => speak(currentInstruction));
        }

        init();
    </script>
    <script>
      // Kid-Proofing: Anti-zoom and multi-touch protection
      document.addEventListener('gesturestart', (e) => e.preventDefault(), { passive: false });
      document.addEventListener('touchstart', (e) => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
    </script>
</body>
</html>