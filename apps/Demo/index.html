<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Sight Words Quiz Deluxe - Web Audio</title>

  <!-- Google Font + Animate.css for quick micro-animations -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <!-- External Libraries for Enhancements (Howler.js removed) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.fog.min.js"></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>  <-- REMOVED -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/progressbar.js/1.1.0/progressbar.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

  <style>
    :root {
      --brand: #26c6da; /* Teal */
      --brand-light: #80deea;
      --brand-dark: #00acc1;
      --bg: #f4f6f8;    /* Light Gray */
      --fg: #333;
      --btn-bg: #fff;
      --btn-border: #ddd;
      --btn-radius: 16px; /* Slightly larger radius */
      --transition: 0.2s ease-in-out;
      --correct-bg: #a5d6a7; /* Light Green */
      --incorrect-bg: #ef9a9a; /* Light Red */
      --shadow-color: rgba(0,0,0,0.1);
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden;font-family:'Poppins',sans-serif;color:var(--fg);
      -webkit-tap-highlight-color:transparent;touch-action:manipulation;}
    
    body { /* Vanta will attach here */
      background-color: var(--bg); /* Fallback if Vanta fails */
    }

    #confetti-canvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000}
    
    /* Old progress bar - hidden */
    #progress-container{display:none;} 

    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 70px; /* Adjusted for circular timer */
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      z-index: 50;
    }

    #score{
      font-size: 1.1rem;font-weight:600;
      background-color: rgba(255,255,255,0.7);
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    
    #timer-wrapper {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 60px; /* Circular timer size */
      height: 60px;
    }
    #circular-timer { width: 100%; height: 100%; }

    #quiz-container{display:flex;justify-content:center;align-items:center;
      min-height: 30vh; /* Ensure space for buttons */
      padding:1rem;
      margin-top: 70px; /* Space for top-bar */
      height: calc(100vh - 70px - 70px); /* Full height minus top and bottom controls */
    }

    .choice-btn{
      flex:1; min-width: 120px; max-width: 200px;
      margin:0 .75rem;padding:1.2rem; font-size:1.8rem; font-weight: 600;
      background:var(--btn-bg);border:2px solid var(--btn-border);border-radius:var(--btn-radius);
      transition:background var(--transition),transform var(--transition), box-shadow var(--transition);
      touch-action:manipulation; cursor:pointer;
      box-shadow: 0 4px 6px var(--shadow-color);
    }
    .choice-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 10px var(--shadow-color);
    }
    .choice-btn:active{transform:scale(0.96); box-shadow: 0 2px 4px var(--shadow-color);}
    .choice-btn.correct { background-color: var(--correct-bg) !important; border-color: green; }
    .choice-btn.incorrect { background-color: var(--incorrect-bg) !important; border-color: darkred; }

    #controls{
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      display:flex;justify-content:space-between;align-items:center;
      padding:1rem 1.5rem; height: 70px;
      background-color: rgba(255,255,255,0.3);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      z-index: 50;
    }
    #timer-display{padding:.6rem 1rem;background:var(--btn-bg);border:2px solid var(--btn-border);border-radius:var(--btn-radius);
      font-weight:600;cursor:pointer; box-shadow: 0 2px 4px var(--shadow-color); font-size: 0.9rem;}
    #listen-btn{font-size:2rem;background:none;border:none;cursor:pointer;outline:none; color: var(--brand-dark);
      padding: 0.5rem; transition: transform 0.2s;}
    #listen-btn:active {transform: scale(0.9);}

    #timer-select{position:absolute;bottom: calc(70px + 0.5rem); /* Above controls bar */
      right:1.5rem;font-size:1rem;padding:.3rem .5rem;display:none;
      border-radius: 8px; border: 1px solid var(--btn-border); box-shadow: 0 2px 5px var(--shadow-color);
    }

    #mascot-container {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      width: 100px; /* Adjust size as needed */
      height: 100px;
      z-index: 5;
      pointer-events: none; /* Allow clicks through mascot */
    }
    #mascot-container lottie-player { width: 100%; height: 100%; }

    /* Floating Score/Message Styles */
    .floating-effect {
      position: fixed; /* Use fixed to float over everything */
      padding: 0.5rem 1rem;
      color: white;
      border-radius: 20px;
      font-weight: bold;
      font-size: 1.2em;
      z-index: 200; /* Above most elements */
      pointer-events: none;
      text-align: center;
    }
    .floating-score { background: rgba(76, 175, 80, 0.9); } /* Green for +1 */
    .floating-message { background: var(--brand); } /* Brand color for streaks */
  </style>
</head>
<body>

  <canvas id="confetti-canvas"></canvas>
  
  <div class="top-bar">
    <div id="score">Score: <span id="score-val">0</span></div>
    <div id="timer-wrapper"><div id="circular-timer"></div></div>
  </div>

  <div id="quiz-container" class="animate__animated">
    <button id="choice0" class="choice-btn"></button>
    <button id="choice1" class="choice-btn"></button>
  </div>

  <div id="controls">
    <div id="timer-display">10s ‚è±Ô∏è</div>
    <button id="listen-btn">üîä</button>
  </div>
  <select id="timer-select"></select>

  <div id="mascot-container">
    <lottie-player src="https://lottie.host/449f9829-8f92-4a63-85a2-def249781a91/p021aHdt2x.json" background="transparent" speed="1" loop autoplay></lottie-player>
  </div>

  <script>
    // --- WEB AUDIO API SOUNDS ---
    const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    // Unlock on first tap/click
    if (audioCtx) { // Check if audioCtx was successfully created
        window.addEventListener('pointerdown', () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }, { once: true });
    }


    function playOsc({ type='sine', freq=440, dur=0.3, modFreq, modIndex, vol=1 }) {
        if (!audioCtx) return; // Don't proceed if audioCtx isn't available

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

        // optional FM
        if (modFreq && modIndex) {
            const mod = audioCtx.createOscillator();
            const mGain = audioCtx.createGain();
            mod.frequency.setValueAtTime(modFreq, audioCtx.currentTime);
            mGain.gain.setValueAtTime(modIndex, audioCtx.currentTime);
            mod.connect(mGain).connect(osc.frequency);
            mod.start(audioCtx.currentTime);
            mod.stop(audioCtx.currentTime + dur);
        }

        osc.connect(gain);
        gain.connect(audioCtx.destination);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime); // Use passed volume
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);

        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + dur);
    }

    // Bell Chime for correct
    function playBell() {
        if (!audioCtx) return;
        // two quick sine tones
        playOsc({ type:'sine', freq:660, dur:0.3, vol: 0.6 }); // Reduced duration slightly for snappiness
        setTimeout(() => playOsc({ type:'sine', freq:880, dur:0.3, vol: 0.6 }), 120); // Reduced delay
    }

    // Square Buzz for incorrect
    function playBuzz() {
        if (!audioCtx) return;
        playOsc({ type:'square', freq:150, dur:0.4, vol: 0.4 }); // Lowered freq and vol for less harshness
    }
    // --- END WEB AUDIO API SOUNDS ---

    // sight words list
    const words = [
      "a","all","am","and","away","be","big","blue","but","can","come",
      "did","down","find","for","funny","go","good","he","help","here","I",
      "in","is","it","like","little","look","make","me","my","no","not",
      "on","one","play","ran","red","run","said","see","so","that","the",
      "three","to","two","up","was","we","what","where","yellow","yes","you"
    ];

    // UI references
    const btns       = [...document.querySelectorAll('.choice-btn')];
    const scoreVal   = document.getElementById('score-val');
    const timerDisp  = document.getElementById('timer-display');
    const timerSel   = document.getElementById('timer-select');
    const listenBtn  = document.getElementById('listen-btn');
    const quizCont   = document.getElementById('quiz-container');

    // Confetti setup
    const confettiCanvas = document.getElementById('confetti-canvas');
    const myConfetti = confetti.create(confettiCanvas, { resize: true, useWorker: true });

    // Vanta.js effect instance
    let vantaEffect;

    // Circular Timer (ProgressBar.js)
    let circleTimerInstance;
    let questionTimeoutId; 
    let questionAnswered = false; 

    // Game state
    let score = 0;
    let timeLimit = 10; 
    let currentCorrect = "";
    let currentStreak = 0;
    const streakThresholds = {3: "Streak x3!", 5: "Super Streak x5!", 10: "AMAZING x10!"};

    // ---- INITIALIZATION ----
    document.addEventListener('DOMContentLoaded', () => {
      initVantaBackground();
      // initSounds(); // REMOVED - Web Audio API handles its own init
      initCircularTimer();
      
      for(let i=0;i<=30;i++){
        let o = document.createElement('option');
        o.value = i; o.textContent = i+'s' + (i === 0 ? ' (Untimed)' : '');
        timerSel.append(o);
      }
      timerSel.value = timeLimit; 
      timerDisp.textContent = timeLimit > 0 ? timeLimit+'s ‚è±Ô∏è' : 'Untimed ‚è±Ô∏è';

      nextQ();
    });

    function initVantaBackground() {
      // ... (Vanta init code remains the same)
      const brandColor = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--brand').trim().substring(1), 16);
      const brandLightColor = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--brand-light').trim().substring(1), 16);
      const brandDarkColor = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--brand-dark').trim().substring(1), 16);
      const bgColor = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--bg').trim().substring(1), 16);

      vantaEffect = VANTA.FOG({
        el: "body",
        mouseControls: true,
        touchControls: true,
        gyroControls: false,
        minHeight: 200.00,
        minWidth: 200.00,
        highlightColor: brandLightColor, 
        midtoneColor: brandColor, 
        lowlightColor: brandDarkColor, 
        baseColor: bgColor, 
        blurFactor: 0.50,
        speed: 1.20,
        zoom: 0.80
      });
    }

    // initSounds() function entirely removed

    function initCircularTimer() {
      // ... (Circular timer init code remains the same)
      const timerContainer = document.getElementById('circular-timer');
      if (!timerContainer) return;

      circleTimerInstance = new ProgressBar.Circle(timerContainer, {
          strokeWidth: 10, 
          easing: 'linear',
          color: 'var(--brand)',
          trailColor: 'rgba(224, 224, 224, 0.5)', 
          trailWidth: 10,
          svgStyle: { width: '100%', height: '100%' },
          text: {
              style: {
                  color: 'var(--fg)',
                  position: 'absolute',
                  left: '50%',
                  top: '50%',
                  padding: 0,
                  margin: 0,
                  transform: { prefix: true, value: 'translate(-50%, -50%)' },
                  fontSize: '1.4em', 
                  fontWeight: '600',
              },
              autoStyleContainer: false
          },
          step: function(state, circle) {
              if (timeLimit > 0) {
                const timeLeft = Math.ceil(timeLimit * (1 - circle.value()));
                circle.setText(timeLeft > 0 ? timeLeft : '0');
                if (timeLeft <= timeLimit * 0.3) {
                    circle.path.setAttribute('stroke', '#f44336'); // Red
                } else if (timeLeft <= timeLimit * 0.6) {
                    circle.path.setAttribute('stroke', '#ff9800'); // Orange
                } else {
                    circle.path.setAttribute('stroke', 'var(--brand)');
                }
              } else {
                circle.setText('‚àû');
                circle.path.setAttribute('stroke', 'var(--brand)');
              }
          }
      });
    }

    function speak(txt){
      if('speechSynthesis' in window){
        speechSynthesis.cancel();
        let u = new SpeechSynthesisUtterance(txt);
        u.rate = 0.9; 
        u.pitch = 1.1;
        speechSynthesis.speak(u);
      }
    }

    function startCountdown(onDoneCallback){
      clearTimeout(questionTimeoutId);
      questionAnswered = false;

      if(circleTimerInstance){
        circleTimerInstance.set(0); 
        circleTimerInstance.setText(timeLimit > 0 ? String(timeLimit) : '‚àû');
        circleTimerInstance.path.setAttribute('stroke', 'var(--brand)'); 

        if(timeLimit <= 0) return; 

        circleTimerInstance.animate(1.0, { duration: timeLimit * 1000 });
        questionTimeoutId = setTimeout(() => {
          if (!questionAnswered) onDoneCallback();
        }, timeLimit * 1000);
      }
    }

    function nextQ(){
      quizCont.classList.remove('animate__fadeIn', 'animate__zoomIn'); 
      void quizCont.offsetWidth; 
      quizCont.classList.add('animate__zoomIn'); 

      const correct = words[Math.floor(Math.random()*words.length)];
      currentCorrect = correct;
      let wrong;
      do {
        wrong = words[Math.floor(Math.random()*words.length)];
      } while(wrong===correct);

      const pair = Math.random()<.5 ? [correct,wrong] : [wrong,correct];

      btns.forEach((b,i)=>{
        b.textContent = pair[i];
        b.disabled = false;
        b.className = 'choice-btn'; 
      });

      speak(correct);
      startCountdown(()=>{ 
        btns.forEach(b=>b.disabled=true);
        playBuzz(); // MODIFIED: Using playBuzz for timeout
        showFloatingMessage("Time's Up!", '#ffcdd2', '#333');
        currentStreak = 0; 
        setTimeout(nextQ,1200); 
      });
    }

    btns.forEach(btn=>{
      btn.addEventListener('click',()=>{
        if (questionAnswered) return;
        questionAnswered = true;
        clearTimeout(questionTimeoutId);
        btns.forEach(b=>b.disabled=true); 

        const isCorrect = btn.textContent === currentCorrect;

        if(isCorrect){
          playBell(); // MODIFIED: Using playBell for correct
          scoreVal.textContent = ++score;
          btn.classList.add('correct', 'animate__animated', 'animate__pulse');
          myConfetti({ particleCount:80, spread:100, origin: { y: 0.6 } });
          showFloatingScore("+1 Awesome!", btn);
          
          currentStreak++;
          if (streakThresholds[currentStreak]) {
            setTimeout(() => { 
              playBell(); // MODIFIED: Reusing playBell for streak
              showFloatingMessage(streakThresholds[currentStreak], 'gold', '#333');
              myConfetti({ particleCount: 150, spread: 180, startVelocity: 45, origin: { y: 0.5 }});
            }, 300);
          }
        } else {
          playBuzz(); // MODIFIED: Using playBuzz for incorrect
          btn.classList.add('incorrect', 'animate__animated', 'animate__shakeX');
          btns.find(b => b.textContent === currentCorrect)?.classList.add('correct');
          showFloatingScore("Oops!", btn, true);
          currentStreak = 0; 
        }
        
        btn.addEventListener('animationend',()=>{
            btn.classList.remove('animate__animated', 'animate__pulse', 'animate__shakeX');
        }, { once:true });

        setTimeout(nextQ, isCorrect ? 1000 : 1800); 
      });
    });

    listenBtn.onclick = ()=>{
      if(currentCorrect) speak(currentCorrect);
    };

    timerDisp.addEventListener('click',()=>{
      timerSel.style.display = timerSel.style.display==='block'?'none':'block';
      timerSel.value = timeLimit; 
    });
    timerSel.addEventListener('change',()=>{
      timeLimit = +timerSel.value;
      timerDisp.textContent = timeLimit > 0 ? timeLimit+'s ‚è±Ô∏è' : 'Untimed ‚è±Ô∏è';
      timerSel.style.display='none';
    });

    function showFloatingScore(message, targetButton, isError = false) {
        // ... (Floating score code remains the same)
        const floatEl = document.createElement('div');
        floatEl.textContent = message;
        floatEl.classList.add('floating-effect');
        floatEl.classList.add(isError ? 'floating-message' : 'floating-score'); 
        if(isError) {floatEl.style.backgroundColor = 'var(--incorrect-bg)'; floatEl.style.color = '#333';}

        document.body.appendChild(floatEl);

        const btnRect = targetButton.getBoundingClientRect();
        floatEl.style.left = `${btnRect.left + btnRect.width / 2 - floatEl.offsetWidth / 2}px`;
        floatEl.style.top = `${btnRect.top - floatEl.offsetHeight - 10}px`; 

        gsap.to(floatEl, {
            y: -60, 
            opacity: 0,
            duration: 1.8,
            ease: 'power1.out',
            onComplete: () => floatEl.remove()
        });
    }

    function showFloatingMessage(text, bgColor = 'var(--brand)', textColor = 'white') {
      // ... (Floating message code remains the same)
      const msgEl = document.createElement('div');
      msgEl.textContent = text;
      msgEl.classList.add('floating-effect', 'floating-message');
      msgEl.style.backgroundColor = bgColor;
      msgEl.style.color = textColor;
      
      msgEl.style.left = '50%';
      msgEl.style.top = '15%'; 
      msgEl.style.transform = 'translateX(-50%)';
      msgEl.style.padding = '0.8rem 1.5rem';
      msgEl.style.fontSize = '1.5em';
      
      document.body.appendChild(msgEl);
      gsap.fromTo(msgEl, 
        { opacity: 0, y: -20, scale: 0.8 }, 
        { opacity: 1, y: 0, scale: 1, duration: 0.5, ease: 'back.out(1.7)' }
      );

      setTimeout(() => {
        gsap.to(msgEl, { 
          opacity: 0, y: 20, scale: 0.8, duration: 0.5, ease: 'back.in(1.7)', 
          onComplete: () => msgEl.remove() 
        });
      }, 2300); 
    }

  </script>
</body>
</html>