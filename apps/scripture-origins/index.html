<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scripture Globe – Bible vs Book of Mormon</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <style>
    :root {
      --bg: #02040a;
      --glass: rgba(6, 8, 14, 0.76);
      --text: #f4f5f6;
      --muted: rgba(244,245,246,0.65);
      --gold: #f3c86b;
      --book-blue: #0f2751;
      --book-black: #000;
      --accent: #44d2ff;
    }
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      background: #02040a;
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100dvh;
      height: 100%;
      overflow: hidden;
    }

    /* 3D layer */
    #scene-container {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100dvh;
      z-index: 1;
      background: radial-gradient(circle at top, #19253a 0%, #02040a 65%, #02040a 100%);
    }

    /* Info bar */
    #info-bar {
      position: fixed;
      left: 10px;
      right: 10px;
      bottom: calc(120px + env(safe-area-inset-bottom, 0px)); /* sits above mobile book bar */
      background: var(--glass);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 14px;
      backdrop-filter: blur(16px);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-start;
      padding: 10px 14px;
      z-index: 20;
    }
    body.touch #info-bar {
      gap: 6px;
    }
    #info-title {
      font-weight: 600;
      font-size: .88rem;
      margin-right: 4px;
      white-space: nowrap;
    }
    #info-text {
      font-size: .78rem;
      line-height: 1.25;
      min-width: 230px;
      flex: 1;
    }
    #focus-hint {
      font-size: .65rem;
      color: var(--muted);
      white-space: nowrap;
    }

    /* Book panel (bottom on mobile) */
    #book-panel {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      min-height: 120px;
      background: radial-gradient(circle at top, rgba(5,7,12,0.05), rgba(5,7,12,0.98));
      border-top: 1px solid rgba(255,255,255,0.035);
      backdrop-filter: blur(16px);
      display: flex;
      gap: 12px;
      padding: 12px 14px calc(18px + env(safe-area-inset-bottom, 0px));
      overflow-x: auto;
      z-index: 30;
      align-items: stretch;
      scroll-snap-type: x proximity;
      -webkit-overflow-scrolling: touch;
    }
    .book-card {
      flex: 0 0 clamp(150px, 45vw, 200px);
      border-radius: 14px;
      padding: 14px 12px 12px;
      border: 1px solid rgba(243, 200, 107, 0.13);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
      transition: transform .12s ease, border .12s ease;
      scroll-snap-align: center;
    }
    .book-card:active {
      transform: scale(.985);
      border: 1px solid rgba(243,200,107,0.6);
    }
    .book-title {
      font-family: "Georgia","Times New Roman",serif;
      text-transform: uppercase;
      line-height: 1.05;
      margin-bottom: .35rem;
      letter-spacing: .045em;
    }
    .book-sub {
      font-size: .7rem;
      opacity: .8;
    }
    .book-card.bible {
      background: radial-gradient(circle at 20% 15%, #121821, #000 50%, #000 100%);
      color: var(--gold);
    }
    .book-card.bom {
      background: radial-gradient(circle at 10% 25%, #123b6e, #091d3a 60%, #030712 100%);
      color: var(--gold);
    }

    /* Desktop layout: panel on right */
    @media (min-width: 900px) {
      #book-panel {
        top: 0;
        right: 0;
        bottom: 0;
        width: 270px;
        min-height: 100vh;
        flex-direction: column;
        overflow-y: auto;
        overflow-x: hidden;
      }
      .book-card {
        flex: 0 0 auto;
      }
      #info-bar {
        bottom: 10px;
        left: 10px;
        right: 290px;
      }
    }

    @media (max-width: 600px) {
      #info-bar {
        flex-direction: column;
        align-items: stretch;
        bottom: calc(150px + env(safe-area-inset-bottom, 0px));
      }
      #info-title {
        font-size: .95rem;
      }
      #info-text {
        font-size: .82rem;
      }
      #focus-hint {
        display: none;
      }
    }

    @media (max-width: 420px) {
      #book-panel {
        gap: 10px;
        padding-left: calc(12px + env(safe-area-inset-left, 0px));
        padding-right: calc(12px + env(safe-area-inset-right, 0px));
      }
      .book-card {
        padding: 12px 12px 10px;
      }
      .book-title {
        font-size: .95rem;
      }
      .book-sub {
        font-size: .68rem;
      }
    }

    /* Fallback panel */
    #fallback {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      text-align: center;
      background: #02040a;
      color: #fff;
      padding: 20px;
      z-index: 200;
    }
    #fallback small {
      display: block;
      opacity: .65;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <!-- 3D canvas host -->
  <div id="scene-container"></div>

  <!-- Info bar -->
  <div id="info-bar">
    <div id="info-title">Bible</div>
    <div id="info-text">
      Events in and around Jerusalem, Israel, Egypt, Assyria/Babylon, and later the Mediterranean world.
    </div>
    <div id="focus-hint">Drag to rotate · Pinch/scroll to zoom</div>
  </div>

  <!-- Book buttons -->
  <div id="book-panel">
    <div class="book-card bible" data-target="bible">
      <div class="book-title">
        <div>THE</div>
        <div>HOLY BIBLE</div>
      </div>
      <div class="book-sub">
        Ancient Near East → Israel, Judah, Egypt, Mesopotamia, then early Christian world.
      </div>
    </div>
    <div class="book-card bom" data-target="bom">
      <div class="book-title">
        <div>THE</div>
        <div>BOOK OF</div>
        <div>MORMON</div>
      </div>
      <div class="book-sub">
        Starts at Jerusalem (~600 BC) → migrates → record kept in the ancient Americas.
      </div>
    </div>
  </div>

  <!-- Fallback if WebGL / script fails -->
  <div id="fallback">
    <div>
      <h2>3D globe not available</h2>
      <p>
        Your device or browser didn't start the 3D view. You can still teach:<br>
        <strong>Bible</strong> = Israel / Near East. <strong>Book of Mormon</strong> = Ancient Americas (people from Jerusalem).
      </p>
      <small>Try Safari/Chrome with hardware acceleration on.</small>
    </div>
  </div>

  <script type="module">
  import * as THREE from "./lib/three.module.min.js";
  import { OrbitControls } from "./lib/OrbitControls.js";

  (function() {
    const sceneHost = document.getElementById("scene-container");
    const infoTitle = document.getElementById("info-title");
    const infoText  = document.getElementById("info-text");
    const focusHint = document.getElementById("focus-hint");
    const bookPanel = document.getElementById("book-panel");
    const fallback  = document.getElementById("fallback");

    let renderLoopActive = true;

    function showFallback(message) {
      if (message) {
        const p = fallback.querySelector("p");
        if (p) {
          p.innerHTML = message;
        }
      }
      fallback.style.display = "flex";
      sceneHost.style.display = "none";
      renderLoopActive = false;
    }

    // 1. GUARD: if THREE did not load for some reason, show fallback immediately.
    if (typeof THREE === "undefined") {
      showFallback("<strong>3D engine not loaded.</strong><br>Please check your connection and try again.");
      return;
    }

    /* ----------------------------------------------------------
       SCENE SETUP
    ---------------------------------------------------------- */
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x030509);

    const camera = new THREE.PerspectiveCamera(
      45,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 1.6, 3.6);

    let renderer;
    try {
      renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true,
        powerPreference: "high-performance",
        precision: "mediump"
      });
    } catch (error) {
      showFallback("<strong>3D view could not start.</strong><br>Your device may need hardware acceleration enabled.");
      return;
    }

    if (!renderer || !renderer.getContext()) {
      showFallback("<strong>WebGL unavailable.</strong><br>Try a newer browser or enable WebGL in your settings.");
      return;
    }

    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.domElement.style.touchAction = "none";
    renderer.domElement.style.width = "100%";
    renderer.domElement.style.height = "100%";
    renderer.domElement.style.display = "block";
    sceneHost.appendChild(renderer.domElement);

    renderer.domElement.addEventListener("webglcontextlost", function(event) {
      if (event && typeof event.preventDefault === "function") {
        event.preventDefault();
      }
      showFallback("<strong>The 3D view was interrupted.</strong><br>Reload the page to try again.");
    });

    if ("maxTouchPoints" in navigator && navigator.maxTouchPoints > 0) {
      document.body.classList.add("touch");
      if (focusHint) {
        focusHint.textContent = "Drag with one finger · Pinch to zoom";
      }
    }

    // LIGHTING
    const hemi = new THREE.HemisphereLight(0xffffff, 0x080820, 1.15);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 1);
    dir.position.set(4, 2, 3.5);
    scene.add(dir);

    // GLOBE
    const RADIUS = 1;
    // --- OPTIMIZATION: Reduced segments from 64x64 to 32x32. Visually identical but much faster.
    const globeGeo = new THREE.SphereGeometry(RADIUS, 32, 32);
    const globeMat = new THREE.MeshStandardMaterial({
      color: 0x0b4b78,
      roughness: 0.45,
      metalness: 0.1
    });
    const globe = new THREE.Mesh(globeGeo, globeMat);
    scene.add(globe);

    // Decorative lat/lon lines
    const latLonGroup = new THREE.Group();
    globe.add(latLonGroup);

    // --- OPTIMIZATION: Replaced inefficient TorusGeometry with efficient Lines for latitude.
    function addLatitude(latDeg) {
        const SEGMENTS = 128;
        const positions = [];
        const rad = THREE.MathUtils.degToRad(latDeg);
        const ringRadius = Math.cos(rad) * RADIUS * 1.002;
        const y = Math.sin(rad) * RADIUS * 1.002;

        for (let i = 0; i <= SEGMENTS; i++) {
            const theta = (i / SEGMENTS) * Math.PI * 2;
            const x = ringRadius * Math.cos(theta);
            const z = ringRadius * Math.sin(theta);
            positions.push(x, y, z);
        }
        const geo = new THREE.BufferGeometry();
        geo.setAttribute("position", new THREE.Float32BufferAttribute(positions, 3));
        const mat = new THREE.LineBasicMaterial({ color: 0x2aa7ff, opacity: 0.2, transparent: true });
        const line = new THREE.Line(geo, mat);
        latLonGroup.add(line);
    }
    function addLongitude(lonDeg) {
      const SEGMENTS = 90;
      const positions = [];
      for (let i = 0; i <= SEGMENTS; i++) {
        const theta = (i / SEGMENTS) * Math.PI - Math.PI/2;
        const r = RADIUS * 1.002;
        const x = r * Math.cos(theta) * Math.cos(THREE.MathUtils.degToRad(lonDeg));
        const y = r * Math.sin(theta);
        const z = r * Math.cos(theta) * Math.sin(THREE.MathUtils.degToRad(lonDeg));
        positions.push(x,y,z);
      }
      const geo = new THREE.BufferGeometry();
      geo.setAttribute("position", new THREE.Float32BufferAttribute(positions, 3));
      const mat = new THREE.LineBasicMaterial({ color: 0x2aa7ff, opacity: 0.12, transparent: true });
      const line = new THREE.Line(geo, mat);
      latLonGroup.add(line);
    }
    for (let lat = -60; lat <= 60; lat += 30) addLatitude(lat);
    for (let lon = -150; lon <= 180; lon += 30) addLongitude(lon);

    // MARKERS GROUP
    const markers = new THREE.Group();
    scene.add(markers);

    function latLonToVec3(lat, lon, radius) {
      const phi = THREE.MathUtils.degToRad(90 - lat);
      const theta = THREE.MathUtils.degToRad(lon + 180);
      const x = -(radius) * Math.sin(phi) * Math.cos(theta);
      const z =  (radius) * Math.sin(phi) * Math.sin(theta);
      const y =  (radius) * Math.cos(phi);
      return new THREE.Vector3(x, y, z);
    }
    function addMarker(lat, lon, color, label) {
      const g = new THREE.SphereGeometry(0.027, 10, 10);
      const m = new THREE.MeshBasicMaterial({ color });
      const mesh = new THREE.Mesh(g, m);
      mesh.position.copy(latLonToVec3(lat, lon, RADIUS * 1.01));
      mesh.userData.label = label;
      markers.add(mesh);
      return mesh;
    }

    addMarker(31.78, 35.23, 0xffeb99, "Jerusalem – central to Bible narrative");
    addMarker(15, -90, 0xff8ba1, "Ancient Americas – teaching location for Book of Mormon peoples");

    // CONTROLS
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.enablePan = false;
    controls.minDistance = 1.5;
    controls.maxDistance = 5.5;
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.6;
    controls.enableZoom = true;
    controls.zoomSpeed = 0.65;
    controls.rotateSpeed = 0.45;
    controls.minPolarAngle = Math.PI / 4;
    controls.maxPolarAngle = Math.PI - Math.PI / 6;

    /* ----------------------------------------------------------
       CAMERA / GLOBE ROTATION
    ---------------------------------------------------------- */
    // --- FIX: Added animation state tracking to prevent conflicts with user input.
    let isAnimating = false;
    let animationFrameId = null;

    function flyTo(lat, lon, title, text) {
      if (isAnimating) {
        cancelAnimationFrame(animationFrameId);
      }
      isAnimating = true;
      controls.enabled = false; // Disable controls during animation
      controls.autoRotate = false;

      const target = latLonToVec3(lat, lon, RADIUS);
      const n = target.clone().normalize();
      const targetPhi   = Math.acos(n.y);
      const targetTheta = Math.atan2(n.x, n.z);

      const startRotY = globe.rotation.y;
      const startRotX = globe.rotation.x;
      // We need to handle rotation wrapping (e.g., from -170deg to +170deg)
      const endRotY   = targetTheta;
      const endRotX   = targetPhi - Math.PI / 2;

      // Find the shortest path for rotation
      const twoPi = Math.PI * 2;
      const deltaY = (endRotY - startRotY + Math.PI) % twoPi - Math.PI;
      const finalEndRotY = startRotY + deltaY;

      const start = performance.now();
      const dur   = 700; // slightly longer for a smoother feel

      function animateRot(now) {
        const t = Math.min(1, (now - start) / dur);
        const e = t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2; // ease in-out cubic

        globe.rotation.y = THREE.MathUtils.lerp(startRotY, finalEndRotY, e);
        globe.rotation.x = THREE.MathUtils.lerp(startRotX, endRotX, e);

        if (t < 1) {
          animationFrameId = requestAnimationFrame(animateRot);
        } else {
          isAnimating = false;
          controls.enabled = true; // Re-enable controls
          controls.autoRotate = true;
          animationFrameId = null;
        }
      }
      animationFrameId = requestAnimationFrame(animateRot);

      infoTitle.textContent = title;
      infoText.textContent  = text;
    }

    /* ----------------------------------------------------------
       POINTER INTERACTION – BOOK CARDS
    ---------------------------------------------------------- */
    function onBookTap(evt) {
      const card = evt.target.closest(".book-card");
      if (!card) return;
      if (typeof evt.preventDefault === "function") {
        evt.preventDefault();
      }
      const tag = card.dataset.target;
      if (tag === "bible") {
        flyTo(
          31.78, 35.23,
          "Bible",
          "The Bible was written in the lands around Israel and the broader Near East. You can tell the girls: “This book comes from over here — Jerusalem and the surrounding world.”"
        );
      } else if (tag === "bom") {
        flyTo(
          15, -90,
          "Book of Mormon",
          "The Book of Mormon begins with a family in Jerusalem, but the record itself is mostly in the ancient Americas. You can tell the girls: “This book is about people over here.”"
        );
      }
    }
    bookPanel.addEventListener("pointerup", onBookTap, { passive: false });
    bookPanel.addEventListener("click", onBookTap);

    /* ----------------------------------------------------------
       POINTER INTERACTION – MARKERS (tap vs drag fix)
    ---------------------------------------------------------- */
    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();
    let pointerDownPos = new THREE.Vector2();
    let pointerDownTime = 0;

    function handleMarkerTap(event) {
        const rect = renderer.domElement.getBoundingClientRect();
        pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        raycaster.setFromCamera(pointer, camera);
        const hits = raycaster.intersectObjects(markers.children);
        if (hits.length > 0) {
            const obj = hits[0].object;
            infoTitle.textContent = "Location";
            infoText.textContent  = obj.userData.label || "Marker";
        }
    }

    renderer.domElement.addEventListener("pointerdown", function(event) {
        pointerDownPos.set(event.clientX, event.clientY);
        pointerDownTime = performance.now();
    });

    renderer.domElement.addEventListener("pointerup", function(event) {
        const dist = pointerDownPos.distanceTo(new THREE.Vector2(event.clientX, event.clientY));
        const time = performance.now() - pointerDownTime;
        // Consider it a tap if pointer moved less than 10px and held for less than 200ms
        if (dist < 10 && time < 200) {
            handleMarkerTap(event);
        }
    });

    renderer.domElement.addEventListener("touchend", function(event) {
      if (event.changedTouches && event.changedTouches.length === 1) {
        const touch = event.changedTouches[0];
        handleMarkerTap({ clientX: touch.clientX, clientY: touch.clientY });
      }
    }, { passive: true });

    /* ----------------------------------------------------------
       ANIMATE LOOP
    ---------------------------------------------------------- */
    function animate() {
      if (!renderLoopActive) {
        return;
      }
      requestAnimationFrame(animate);
      // Only update controls if not in a programmatic animation
      if (!isAnimating) {
        controls.update();
      }
      renderer.render(scene, camera);
    }
    animate();

    /* ----------------------------------------------------------
       RESIZE
    ---------------------------------------------------------- */
    window.addEventListener("resize", function() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
    });

    /* ----------------------------------------------------------
       INITIAL VIEW
    ---------------------------------------------------------- */
    flyTo(
      31.78, 35.23,
      "Bible",
      "Events in and around Jerusalem, Israel, Egypt, Assyria/Babylon, and later the Mediterranean world."
    );

  })();
  
  </script>
  <script nomodule>
    (function() {
      const fallback = document.getElementById("fallback");
      const sceneHost = document.getElementById("scene-container");
      if (!fallback || !sceneHost) return;
      const p = fallback.querySelector("p");
      if (p) {
        p.innerHTML = "<strong>This browser cannot display the interactive globe.</strong><br>Try the latest Safari or Chrome.";
      }
      fallback.style.display = "flex";
      sceneHost.style.display = "none";
    })();
  </script>
</body>
</html>

