<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User's Chores</title>
    <style>
        :root {
            --page-bg: #F0E6FF;
            --title-purple: #5D3A9B;
            --header-bg: #DCD0FF;
            --chore-col-bg: #EAE0FF;
            --cell-bg: #F8F0FF;
            --grid-border: #BEA6E0;
            --text-dark: #4A2E87;
            --icon-color: #785A9B;
            --accent-color: #9B59B6;
            --completed-bounce: bounce-effect 0.3s ease;
            --button-subtle-bg: #EAE0FF;
            --button-subtle-hover-bg: #DCD0FF;
            --button-subtle-text: var(--title-purple);
            --edit-list-item-bg: #fdfaff;
            --edit-list-item-border: #e0d4f5;
        }

        @keyframes bounce-effect {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        @keyframes sparkle-effect {
            0% { opacity: 1; transform: scale(0) rotate(0deg); }
            50% { opacity: 0.8; transform: scale(1.5) rotate(180deg); }
            100% { opacity: 0; transform: scale(0) rotate(360deg); }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--page-bg);
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: var(--page-bg); 
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        header h1#page-title { 
            font-family: Georgia, 'Times New Roman', Times, serif;
            color: var(--title-purple);
            text-align: center;
            font-size: 2.8em;
            margin-bottom: 15px;
            cursor: pointer; 
            user-select: none; 
            -webkit-user-select: none; 
            -moz-user-select: none; 
            -ms-user-select: none; 
            -webkit-touch-callout: none; 
        }

        .week-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 5px 0;
            border-bottom: 1px solid var(--grid-border);
            border-top: 1px solid var(--grid-border);
        }

        .week-navigation button {
            background-color: var(--button-subtle-bg);
            color: var(--button-subtle-text);
            border: 1px solid var(--grid-border);
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
        }
        .week-navigation button:hover {
            background-color: var(--button-subtle-hover-bg);
        }
        .week-navigation span#week-dates-display {
            font-size: 1.1em;
            color: var(--title-purple);
            font-weight: bold;
            text-align: center;
            flex-grow: 1;
        }

        .chore-chart-wrapper {
            background-color: var(--chore-col-bg); 
            border-radius: 10px;
            overflow: hidden; 
            border: 1px solid var(--grid-border);
        }
        
        .chore-chart table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .chore-chart th, .chore-chart td {
            border: 1px solid var(--grid-border);
            text-align: center;
            padding: 8px;
            height: 70px; 
            box-sizing: border-box;
        }

        .chore-chart th {
            background-color: var(--header-bg);
            color: var(--title-purple);
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .chore-chart td.chore-label-cell {
            background-color: var(--chore-col-bg);
            font-weight: bold;
            font-size: 0.9em;
            color: var(--title-purple);
            padding: 5px;
            vertical-align: middle;
            position: relative; 
        }
        
        .chore-label-cell .chore-item-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .chore-label-cell .chore-icon-svg svg { 
            width: 32px;
            height: 32px;
            fill: var(--icon-color);
        }
        .chore-label-cell .chore-icon-emoji { 
             font-size: 32px; 
        }
        
        .chore-label-cell .chore-name {
            font-size: 0.9em;
        }

        .chore-chart td.task-cell {
            background-color: var(--cell-bg);
            cursor: pointer;
            font-size: 1.8em; 
            transition: background-color 0.2s ease;
            position: relative; 
        }

        .chore-chart td.task-cell:hover {
            background-color: #e8dfff;
        }
        
        .chore-chart tr:last-child td:first-child.chore-label-cell {
            border-bottom-left-radius: 10px;
        }
        .chore-chart tr:last-child td:last-of-type.task-cell { 
             border-bottom-right-radius: 10px;
        }

        .sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: gold;
            border-radius: 50%;
            pointer-events: none;
            animation: sparkle-effect 0.6s forwards;
        }

        .controls {
            text-align: center;
            margin-top: 25px;
            display: flex;
            gap: 10px;
            justify-content: center; 
            align-items: center;
            flex-wrap: wrap;
        }
         .controls > * { 
            margin-right: 10px; 
        }
        .controls > *:last-child {
            margin-right: 0;
        }
        .controls p {
             flex-grow: 1; 
             text-align: center; 
        }


        .controls button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px; 
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em; 
            transition: background-color 0.2s ease;
            white-space: nowrap; 
        }

        .controls button:hover {
            background-color: #8E44AD;
        }
        
        .parent-controls { 
            display: none; 
            flex-direction: column;
            gap: 15px; 
            margin-top: 15px;
            padding: 15px;
            border: 1px dashed var(--accent-color);
            border-radius: 8px;
            background-color: #fdfaff;
        }

        .parent-controls h3, .parent-controls h4 {
            color: var(--title-purple);
            margin-top: 0;
            margin-bottom: 10px;
        }

        .parent-controls .chore-form-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--grid-border);
        }

        .parent-controls .parent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 10px;
            align-items: center;
            margin-bottom:10px;
        }
        
        .parent-mode-active .parent-controls {
            display: flex; 
        }

        .parent-controls input[type="text"], .parent-controls select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--grid-border);
            box-sizing: border-box;
            width: 100%; 
        }
        
        .parent-controls button {
            padding: 10px 15px;
            font-size: 0.9em;
            background-color: var(--accent-color); 
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
        }
        .parent-controls button:hover {
            background-color: #8E44AD; 
        }
        .parent-controls button.button-subtle, 
        .parent-controls button#cancel-edit-chore-button {
            background-color: var(--button-subtle-bg);
            color: var(--button-subtle-text);
            border: 1px solid var(--grid-border);
        }
        .parent-controls button.button-subtle:hover,
        .parent-controls button#cancel-edit-chore-button:hover {
            background-color: var(--button-subtle-hover-bg);
        }
        .parent-controls .chore-form-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        .parent-controls .chore-form-buttons.two-buttons {
            grid-template-columns: 1fr 1fr;
        }


        #editable-chores-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--edit-list-item-border);
            border-radius: 5px;
            padding: 5px;
        }
        .editable-chore-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background-color: var(--edit-list-item-bg);
            border-bottom: 1px solid var(--edit-list-item-border);
            font-size: 0.9em;
        }
        .editable-chore-item:last-child {
            border-bottom: none;
        }
        .editable-chore-item span {
            flex-grow: 1;
            margin-right: 10px;
        }
        .editable-chore-item button {
            padding: 5px 10px;
            font-size: 0.8em;
            width: auto;
            flex-shrink: 0;
            background-color: var(--button-subtle-bg);
            color: var(--button-subtle-text);
             border: 1px solid var(--grid-border);
        }
         .editable-chore-item button:hover {
            background-color: var(--button-subtle-hover-bg);
        }


        .parent-controls .io-buttons-grid { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--grid-border);
        }
        
        .delete-chore-btn {
            display: none; 
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
        }
        
        .parent-mode-active .delete-chore-btn {
            display: block; 
        }

        #reward-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2ECC71;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-size: 1.2em;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s, top 0.5s;
        }

        #reward-notification.show {
            opacity: 1;
            visibility: visible;
            top: 50px;
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Ensure it's on top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--page-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 450px;
            position: relative;
            color: var(--text-dark);
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.8em;
            color: var(--text-dark);
            background: none;
            border: none;
            cursor: pointer;
        }
        .modal-close-btn:hover {
            color: var(--title-purple);
        }

        .modal-title {
            color: var(--title-purple);
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .modal-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
            width: 100%;
            box-sizing: border-box;
        }
        .modal-button:hover {
            background-color: #8E44AD;
        }
        .modal-button-subtle {
            background-color: var(--button-subtle-bg);
            color: var(--button-subtle-text);
            border: 1px solid var(--grid-border);
        }
        .modal-button-subtle:hover {
            background-color: var(--button-subtle-hover-bg);
        }

        .modal-user-list {
            max-height: 150px; /* Or adjust as needed */
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid var(--grid-border);
            border-radius: 5px;
        }
        .modal-user-list-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--edit-list-item-border);
            background-color: var(--edit-list-item-bg);
            font-size: 1em;
        }
        .modal-user-list-item:last-child {
            border-bottom: none;
        }
        .modal-user-list-item:hover {
            background-color: var(--button-subtle-hover-bg);
        }
        #modal-new-user-name-input { /* Specific ID selector */
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--grid-border);
            box-sizing: border-box;
            width: 100%;
            margin-bottom: 10px;
            font-size: 1em;
        }
        .modal-form-buttons {
            display: flex;
            gap: 10px;
        }
        .modal-form-buttons .modal-button {
            flex-grow: 1;
        }


        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            header h1#page-title { font-size: 2.2em; margin-bottom: 15px; }
            .week-navigation span#week-dates-display { font-size: 1em; }
            .week-navigation button { padding: 6px 10px; font-size: 0.8em;}
            .chore-chart th, .chore-chart td { padding: 6px; height: 60px; }
            .chore-chart th { font-size: 0.75em; }
            .chore-label-cell .chore-icon-svg svg { width: 24px; height: 24px;}
            .chore-label-cell .chore-icon-emoji { font-size: 24px; }
            .chore-label-cell .chore-name { font-size: 0.8em; }
            .chore-chart td.task-cell { font-size: 1.5em; }
            .controls button { padding: 8px 12px; font-size: 0.85em; }
             .parent-controls .parent-grid { grid-template-columns: 1fr; } 
        }
        @media (max-width: 480px) {
            header h1#page-title { font-size: 1.8em; }
            .week-navigation { flex-wrap: wrap; justify-content: center; }
            .week-navigation span#week-dates-display { font-size: 0.9em; order: -1; width: 100%; margin-bottom: 5px;}
            .week-navigation button { padding: 5px 8px; font-size: 0.75em;}
            .modal-content { width: 95%; padding: 20px;}
            .modal-title { font-size: 1.3em; margin-bottom: 15px;}
            .modal-button {padding: 10px;}
            .chore-chart th { font-size: 0.6em; } 
            .chore-label-cell .chore-icon-svg svg { width: 20px; height: 20px;}
            .chore-label-cell .chore-icon-emoji { font-size: 20px; }
            .chore-label-cell .chore-name { font-size: 0.7em; }
            .chore-chart td.task-cell { font-size: 1.2em; }
            .chore-chart td, .chore-chart th { padding: 4px; height: 50px;}
            .chore-chart-wrapper {overflow-x: auto;} 
            .chore-chart table {min-width: 320px;} 
            .controls { 
                flex-direction: row; 
                justify-content: space-around; 
             }
            .controls button { width: auto; flex-shrink: 0;}
            .controls p { margin: 5px 0; text-align: center; flex-grow: 0;} 
            .parent-controls .parent-grid, .parent-controls .io-buttons-grid { grid-template-columns: 1fr; } 
            .parent-controls .chore-form-buttons.two-buttons { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="page-title">User's Chores</h1>
        </header>
        <main>
            <div class="week-navigation">
                <button id="prev-week-button">< Prev Week</button>
                <span id="week-dates-display"></span>
                <button id="next-week-button">Next Week ></button>
            </div>

            <div class="chore-chart-wrapper">
                <div class="chore-chart">
                    <table>
                        <thead>
                            <tr id="chore-chart-header-row">
                            </tr>
                        </thead>
                        <tbody id="chore-grid-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="controls">
                <button id="toggle-view-button">Switch to Today's View</button>
                <p>Points This Week: <span id="total-points">0</span></p>
            </div>
            
            <div class="parent-controls" id="parent-controls-section">
                <h3>Parent Mode</h3>
                <div class="chore-form-section">
                    <h4>Add New / Edit Chore</h4>
                    <div class="parent-grid">
                        <input type="text" id="new-chore-name" placeholder="Chore name">
                        <select id="new-chore-icon-type">
                            <option value="emoji">Emoji</option>
                            <option value="svg">SVG (Preset Key)</option>
                        </select>
                        <input type="text" id="new-chore-icon-value" placeholder="Emoji (e.g. ✨) or SVG key">
                    </div>
                    <div class="chore-form-buttons">
                        <button id="save-chore-button">Add Chore</button>
                        <button id="cancel-edit-chore-button" style="display: none;">Cancel Edit</button>
                    </div>
                </div>
                
                <div class="existing-chores-section">
                    <h4>Existing Chores (for current user)</h4>
                    <div id="editable-chores-list">
                        <!-- Chore list will be populated here by JS -->
                    </div>
                </div>

                <div class="io-buttons-grid"> 
                    <button id="download-data-button">Download ALL Users Data</button>
                    <button id="upload-data-button">Upload ALL Users Data</button>
                    <input type="file" id="upload-file-input" accept=".json" style="display: none;">
                </div>
                <button id="reset-week-button" class="button-subtle">Reset THIS User's Week</button>
                <button id="exit-parent-mode-button">Exit Parent Mode</button>
            </div>
        </main>
    </div>

    <div id="reward-notification">
        🎉 You earned a reward! Keep up the great work! ⭐
    </div>

    <!-- Custom Modal HTML -->
    <div id="custom-modal-overlay" class="modal-overlay">
        <div id="custom-modal" class="modal-content">
            <button id="modal-close-button" class="modal-close-btn">×</button>
            
            <div id="modal-initial-menu" class="modal-section">
                <h3 class="modal-title">Choose Action</h3>
                <button id="modal-parent-mode-btn" class="modal-button">Enter Parent Mode</button>
                <button id="modal-switch-user-btn" class="modal-button">Switch / Create User</button>
            </div>

            <div id="modal-user-management" class="modal-section" style="display: none;">
                <h3 class="modal-title">Manage Users</h3>
                <div id="modal-user-list" class="modal-user-list">
                    <!-- User list populated by JS -->
                </div>
                <button id="modal-show-create-user-form-btn" class="modal-button">Create New User</button>
                <div id="modal-new-user-form" style="display: none; margin-top: 15px;">
                    <input type="text" id="modal-new-user-name-input" placeholder="New Profile Name">
                    <div class="modal-form-buttons">
                        <button id="modal-confirm-create-user-btn" class="modal-button">Create</button>
                        <button id="modal-cancel-create-user-btn" class="modal-button modal-button-subtle">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const choreGridBody = document.getElementById('chore-grid-body');
        const choreChartHeaderRow = document.getElementById('chore-chart-header-row');
        const resetWeekButton = document.getElementById('reset-week-button');
        const toggleViewButton = document.getElementById('toggle-view-button');
        const totalPointsDisplay = document.getElementById('total-points');
        const rewardNotification = document.getElementById('reward-notification');
        const pageTitleElement = document.getElementById('page-title'); 
        
        const parentControlsSection = document.getElementById('parent-controls-section');
        const newChoreNameInput = document.getElementById('new-chore-name');
        const newChoreIconTypeInput = document.getElementById('new-chore-icon-type');
        const newChoreIconValueInput = document.getElementById('new-chore-icon-value');
        const saveChoreButton = document.getElementById('save-chore-button');
        const cancelEditChoreButton = document.getElementById('cancel-edit-chore-button');
        const editableChoresListContainer = document.getElementById('editable-chores-list');
        const choreFormButtonsContainer = document.querySelector('.chore-form-buttons');

        const exitParentModeButton = document.getElementById('exit-parent-mode-button');
        const downloadDataButton = document.getElementById('download-data-button');
        const uploadDataButton = document.getElementById('upload-data-button');
        const uploadFileInput = document.getElementById('upload-file-input');
        const prevWeekButton = document.getElementById('prev-week-button');
        const nextWeekButton = document.getElementById('next-week-button');
        const weekDatesDisplay = document.getElementById('week-dates-display');

        // Modal DOM Elements
        const customModalOverlay = document.getElementById('custom-modal-overlay');
        const customModal = document.getElementById('custom-modal'); // Though direct interaction might be less
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalInitialMenu = document.getElementById('modal-initial-menu');
        const modalParentModeBtn = document.getElementById('modal-parent-mode-btn');
        const modalSwitchUserBtn = document.getElementById('modal-switch-user-btn');
        const modalUserManagement = document.getElementById('modal-user-management');
        const modalUserList = document.getElementById('modal-user-list');
        const modalShowCreateUserFormBtn = document.getElementById('modal-show-create-user-form-btn');
        const modalNewUserForm = document.getElementById('modal-new-user-form');
        const modalNewUserNameInput = document.getElementById('modal-new-user-name-input');
        const modalConfirmCreateUserBtn = document.getElementById('modal-confirm-create-user-btn');
        const modalCancelCreateUserBtn = document.getElementById('modal-cancel-create-user-btn');


        // App State
        const PARENT_PASSWORD = ""; 
        let isParentModeActive = false;
        let currentView = 'weekly'; 
        let editingChoreId = null;
        let currentWeekStartDate = null;

        let appProfilesData = {}; 
        let currentUserId = null;   

        const svgIcons = { 
            stuffies_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c2.481 0 4.5-2.019 4.5-4.5S18.981 3 16.5 3C14.02 3 12 5.019 12 7.5c0 .88.25 1.691.681 2.385C11.625 9.319 10.5 8.458 10.5 7.5 10.5 5.019 8.481 3 6 3S1.5 5.019 1.5 7.5c0 .958.625 1.819 1.681 2.385C3.25 10.691 3 11.5 3 12.375c0 2.306 1.001 4.363 2.626 5.752C6.042 19.046 7.5 21 7.5 21h9s1.458-1.954 1.874-2.873C20.001 16.738 21 14.681 21 12.375c0-.875-.25-1.681-.681-2.385.944-.548 1.681-1.473 1.681-2.49C22 6.019 19.981 4 17.5 4S13 6.019 13 8.5c0 .958.625 1.819 1.681 2.385C14.75 11.691 14.5 12.5 14.5 13.375c0 1.422.499 2.729 1.32 3.768.091.112.185.222.28.332H7.9c.095-.11.189-.22.28-.332.821-1.039 1.32-2.346 1.32-3.768 0-.875-.25-1.681-.681-2.385C9.769 10.319 10.5 9.458 10.5 8.5 10.5 7.078 9.422 6 8 6S5.5 7.078 5.5 8.5c0 .958.625 1.819 1.681 2.385C7.25 11.691 7 12.5 7 13.375c0 1.763.708 3.35 1.846 4.52L7.5 20l-1.346-2.107A5.98 5.98 0 0 1 4.5 13.375C4.5 12.5 4.75 11.691 5.181 11C4.237 10.452 3.5 9.527 3.5 8.5 3.5 6.019 5.519 4 8 4s4.5 2.019 4.5 4.5c0 .958-.625 1.819-1.681 2.385C10.75 10.691 11 11.5 11 12.375c0 .479-.073.941-.209 1.381.711.301 1.36.713 1.909 1.232.55-.519 1.199-.931 1.909-1.232C14.427 13.316 14.354 12.854 14.354 12.375 14.354 11.5 14.604 10.691 15.035 11c-.944-.548-1.681-1.473-1.681-2.49C13.354 7.078 14.432 6 15.854 6s2.5 1.078 2.5 2.5c0 .958-.625 1.819-1.681 2.385C16.604 10.691 16.854 11.5 16.854 12.375c0 .479-.073.941-.209 1.381.711.301 1.36.713 1.909 1.232.55-.519 1.199-.931 1.909-1.232C19.927 13.316 19.854 12.854 19.854 12.375c0-.875.25-1.681.681-2.385.944-.548 1.681-1.473 1.681-2.49C20.354 6.019 18.335 4 15.854 4c-1.422 0-2.5.922-2.5 2.344V7.5c0 .88.25 1.691.681 2.385.001 0 .001 0 .001 0h.001C14.035 10.309 14.035 10.309 14.035 10.309zM8 18H6v-2h2v2zm8 0h-2v-2h2v2z"></path></svg>',
            dolls_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 5.5A3.5 3.5 0 0 0 8.5 9H7a5 5 0 0 1 10 0h-1.5a3.5 3.5 0 0 0-3.5-3.5zM12 14c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>',
            books_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V5h10v6z"/></svg>',
            dirty_clothes_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.5 6C18.5 5.17 17.83 4.5 17 4.5H14.82C14.4 3.34 13.3 2.5 12 2.5S9.6 3.34 9.18 4.5H7C6.17 4.5 5.5 5.17 5.5 6V7H4V19.5C4 20.33 4.67 21 5.5 21H18.5C19.33 21 20 20.33 20 19.5V7H18.5V6ZM12 4.5C12.55 4.5 13 4.95 13 5.5V6H11V5.5C11 4.95 11.45 4.5 12 4.5ZM18 19H6V9H18V19Z"/></svg>',
            house_toys_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>',
            medical_toys_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.11 0-1.99.89-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.11-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z"/></svg>',
            mystery_things_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v2h-2zm0 4h2v6h-2z"/></svg>'
        };
        const initialChoresDefinitionsTemplate = [ 
            { id: 'stuffies', name: 'Stuffies', iconType: 'emoji', iconValue: '🧸' }, 
            { id: 'dolls', name: 'Dolls', iconType: 'emoji', iconValue: '🎀' },     
            { id: 'books', name: 'Books', iconType: 'emoji', iconValue: '📚' },      
            { id: 'dirty_clothes', name: 'Dirty Clothes', iconType: 'emoji', iconValue: '🧺' }, 
            { id: 'house_toys', name: 'House Toys', iconType: 'emoji', iconValue: '🏠' }, 
            { id: 'medical_toys', name: 'Medical Toys', iconType: 'emoji', iconValue: '🩹' },
            { id: 'mystery_things', name: 'Mystery Things', iconType: 'emoji', iconValue: '📦' } 
        ];

        const rewardThreshold = 28; 
        const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        const taskIcons = ['', '✔️', '🌟', '💖'];
        const taskPoints = [0, 1, 2, 3];

        // --- User Data Accessor Functions ---
        function getCurrentUserProfile() {
            return currentUserId ? appProfilesData[currentUserId] : null;
        }
        function getCurrentUserChores() {
            const profile = getCurrentUserProfile();
            return profile ? profile.chores : [];
        }
        function getCurrentUserAppData() {
            const profile = getCurrentUserProfile();
            return profile ? profile.appData : {};
        }

        // --- Date Helper Functions ---
        function getWeekStartDate(d) { 
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day;
            return new Date(date.setDate(diff));
        }
        function getWeekEndDate(d) {
            const startDate = getWeekStartDate(d);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            return endDate;
        }
        function formatDateDisplay(date) { 
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        function getWeekId(date) { 
            const d = new Date(date);
            d.setHours(0,0,0,0);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function isSameDay(date1, date2) {
             return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }
        function isCurrentRealWeek() {
            if (!currentWeekStartDate) return false;
            const today = new Date();
            const startOfThisRealWeek = getWeekStartDate(today);
            return isSameDay(currentWeekStartDate, startOfThisRealWeek);
        }

        // --- Modal Logic ---
        function showCustomModal(sectionToShow = 'initialMenu') {
            modalInitialMenu.style.display = 'none';
            modalUserManagement.style.display = 'none';
            modalNewUserForm.style.display = 'none'; 

            if (sectionToShow === 'initialMenu') {
                modalInitialMenu.style.display = 'flex';
            } else if (sectionToShow === 'userManagement') {
                populateModalUserList();
                modalUserManagement.style.display = 'flex';
            } else if (sectionToShow === 'newUserFormWithinManagement') {
                populateModalUserList(); 
                modalUserManagement.style.display = 'flex';
                modalNewUserForm.style.display = 'block'; 
                modalNewUserNameInput.value = ''; // Clear previous input
                modalNewUserNameInput.focus();
            }
            customModalOverlay.classList.add('show');
        }

        function hideCustomModal() {
            customModalOverlay.classList.remove('show');
            modalNewUserNameInput.value = '';
        }

        function populateModalUserList() {
            modalUserList.innerHTML = '';
            const userIds = Object.keys(appProfilesData);
            if (userIds.length === 0) {
                modalUserList.innerHTML = '<p style="text-align:center; padding:10px;">No users yet. Create one!</p>';
            } else {
                userIds.forEach(userId => {
                    const userProfile = appProfilesData[userId];
                    const listItem = document.createElement('div');
                    listItem.classList.add('modal-user-list-item');
                    listItem.textContent = userProfile.profileName || userId;
                    listItem.dataset.userId = userId;
                    listItem.addEventListener('click', () => {
                        switchUser(userId);
                        hideCustomModal();
                    });
                    modalUserList.appendChild(listItem);
                });
            }
        }


        // --- Core Logic & UI Rendering ---
        function initApp() {
            loadAllProfilesData(); 
            if (!currentUserId || !appProfilesData[currentUserId]) {
                const userIds = Object.keys(appProfilesData);
                if (userIds.length > 0) {
                    currentUserId = userIds[0]; 
                    loadUser(currentUserId);
                } else {
                    // No users exist, prompt to create the very first one using the modal
                    showCustomModal('newUserFormWithinManagement'); 
                    // Slightly different flow: modal expects user management section to be technically active
                    // To make it cleaner for first time, we might need a dedicated 'firstUser' modal state or a direct call.
                    // For now, let's ensure the `handleCreateNewUserFromModal` is robust.
                    // The 'userManagement' part of the modal will show "No users yet".
                    // Or, call the non-modal one if it's truly the first time ever.
                    // Let's use a flag or check to decide.
                    if (Object.keys(appProfilesData).length === 0 && !currentUserId) {
                         // This implies it's the very first run or all data was wiped.
                         // We want them to create a user. Let's use the modal directly.
                         // Show the user management section, which will guide to create new.
                        pageTitleElement.textContent = "Create First User"; // Guide user
                        showCustomModal('userManagement'); // This shows "No users" and "Create New"
                    }
                }
            } else {
                loadUser(currentUserId);
            }
            deactivateParentMode(); 
        }


        function loadUser(userId) {
            currentUserId = userId;
            const userProfile = getCurrentUserProfile();
            if (!userProfile) {
                console.error("Error: Attempted to load non-existent user:", userId);
                // Fallback if something went wrong during user creation/selection
                pageTitleElement.textContent = "Error Loading User";
                showCustomModal('userManagement'); // Guide to select/create
                return;
            }

            pageTitleElement.textContent = userProfile.profileName || "User's Chores";
            navigateToWeek(getWeekStartDate(new Date())); 
            resetChoreForm();
            if (isParentModeActive) {
                 renderEditableChoresListForCurrentUser();
            }
            saveCurrentUserId();
        }
        
        function navigateToWeek(targetStartDate) {
            if (!currentUserId) return; 

            currentWeekStartDate = getWeekStartDate(targetStartDate);
            currentWeekStartDate.setHours(0,0,0,0);
            
            const weekId = getWeekId(currentWeekStartDate);
            const userAppData = getCurrentUserAppData();

            if (!userAppData[weekId]) {
                userAppData[weekId] = { completionStatus: {}, points: 0 };
            }
            
            updateWeekDateDisplay();
            updateToggleViewButtonText();
            renderGrid();
            updatePointsDisplay();
        }

        function updateWeekDateDisplay() {
            if (!currentWeekStartDate) return;
            const startDate = currentWeekStartDate;
            const endDate = getWeekEndDate(startDate);
            weekDatesDisplay.textContent = `${formatDateDisplay(startDate)} - ${formatDateDisplay(endDate)}`;
        }
        
        function getChoreIconHTML(chore) {
            if (chore.iconType === 'emoji') {
                return `<span class="chore-icon-emoji">${chore.iconValue}</span>`;
            } else if (chore.iconType === 'svg' && svgIcons[chore.iconValue]) {
                return `<div class="chore-icon-svg">${svgIcons[chore.iconValue]}</div>`;
            }
            return `<span class="chore-icon-emoji">❓</span>`; 
        }

        function renderGrid() {
            choreChartHeaderRow.innerHTML = '';
            choreGridBody.innerHTML = '';

            if (!currentUserId || !currentWeekStartDate) {
                choreGridBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">Please select or create a user.</td></tr>';
                totalPointsDisplay.textContent = "0"; // Ensure points reset
                updateToggleViewButtonText(); // Update button state
                return;
            }

            const userChores = getCurrentUserChores();
            const userAppData = getCurrentUserAppData();
            const weekId = getWeekId(currentWeekStartDate);
            const currentWeekData = userAppData[weekId] || { completionStatus: {}, points: 0 };
            const weekCompletionStatus = currentWeekData.completionStatus;
            
            let daysToDisplayConfig = days.map((day, index) => ({ name: day, index: index }));

            if (currentView === 'daily' && isCurrentRealWeek()) {
                const todayRealDate = new Date();
                const todayDayIndex = todayRealDate.getDay();
                daysToDisplayConfig = [{ name: days[todayDayIndex], index: todayDayIndex }];
            }

            const emptyHeaderCell = document.createElement('th');
            emptyHeaderCell.classList.add('chore-header-cell');
            choreChartHeaderRow.appendChild(emptyHeaderCell);

            daysToDisplayConfig.forEach(dayConfig => {
                const dayHeaderCell = document.createElement('th');
                dayHeaderCell.classList.add('day-header-cell');
                dayHeaderCell.textContent = dayConfig.name;
                choreChartHeaderRow.appendChild(dayHeaderCell);
            });

            if (userChores.length === 0) {
                 choreGridBody.innerHTML = `<tr><td colspan="${daysToDisplayConfig.length + 1}" style="text-align:center; padding: 20px;">No chores defined for this user. Add some in Parent Mode!</td></tr>`;
                 updatePointsDisplay(); 
                 return;
            }

            userChores.forEach(chore => {
                const row = document.createElement('tr');
                row.dataset.choreId = chore.id;
                const labelCell = document.createElement('td');
                labelCell.classList.add('chore-label-cell');
                labelCell.innerHTML = `
                    <div class="chore-item-content">
                        ${getChoreIconHTML(chore)}
                        <span class="chore-name">${chore.name}</span>
                    </div>
                    <button class="delete-chore-btn" data-chore-id="${chore.id}">X</button>
                `;
                row.appendChild(labelCell);
                
                const deleteBtn = labelCell.querySelector('.delete-chore-btn');
                if (deleteBtn) {
                    deleteBtn.style.display = isParentModeActive ? 'block' : 'none';
                    deleteBtn.onclick = () => deleteChoreForCurrentUser(chore.id);
                }

                daysToDisplayConfig.forEach(dayConfig => {
                    const dayIndex = dayConfig.index;
                    const cell = document.createElement('td');
                    cell.classList.add('task-cell');
                    cell.dataset.choreId = chore.id;
                    cell.dataset.dayIndex = dayIndex;
                    const statusKey = `${chore.id}_${dayIndex}`;
                    const currentStatus = weekCompletionStatus[statusKey] || 0;
                    cell.innerHTML = taskIcons[currentStatus];
                    if (currentStatus > 0) cell.style.animation = 'none';
                    cell.addEventListener('click', () => handleTaskClick(cell, chore.id, dayIndex));
                    row.appendChild(cell);
                });
                choreGridBody.appendChild(row);
            });
            toggleParentModeUIElements(); 
        }
        
        function handleTaskClick(cell, choreId, dayIndex) {
            if (!currentUserId || !currentWeekStartDate) return;

            const userAppData = getCurrentUserAppData();
            const weekId = getWeekId(currentWeekStartDate);
            if (!userAppData[weekId]) userAppData[weekId] = { completionStatus: {}, points: 0 };
            
            const statusKey = `${choreId}_${dayIndex}`;
            let oldStatus = userAppData[weekId].completionStatus[statusKey] || 0;
            const pointsForOldStatus = taskPoints[oldStatus];
            let newStatus = (oldStatus + 1) % taskIcons.length;
            userAppData[weekId].completionStatus[statusKey] = newStatus;
            cell.innerHTML = taskIcons[newStatus];
            const pointsForNewStatus = taskPoints[newStatus];

            userAppData[weekId].points -= pointsForOldStatus;
            userAppData[weekId].points += pointsForNewStatus;
            
            cell.style.animation = 'none'; 
            void cell.offsetWidth; 
            cell.style.animation = 'var(--completed-bounce)'; 
            if (newStatus > 0) createSparkles(cell);
            
            updatePointsDisplay();
            checkRewardForCurrentUser();
            saveAllProfilesData();
        }

        function createSparkles(cell) { 
             for (let i = 0; i < 5; i++) { 
                const sparkle = document.createElement('div');
                sparkle.classList.add('sparkle');
                sparkle.style.left = `${Math.random() * 80 + 10}%`; 
                sparkle.style.top = `${Math.random() * 80 + 10}%`;
                sparkle.style.backgroundColor = ['gold', 'lightpink', 'lightblue'][Math.floor(Math.random() * 3)];
                cell.appendChild(sparkle);
                setTimeout(() => sparkle.remove(), 600); 
            }
        }

        function updatePointsDisplay() {
            if (!currentUserId || !currentWeekStartDate) {
                totalPointsDisplay.textContent = "0";
                return;
            }
            const userAppData = getCurrentUserAppData();
            const weekId = getWeekId(currentWeekStartDate);
            const pointsForWeek = (userAppData && userAppData[weekId]) ? userAppData[weekId].points : 0;
            totalPointsDisplay.textContent = pointsForWeek;
        }

        function checkRewardForCurrentUser() {
            if (!currentUserId || !currentWeekStartDate) return;
            const userAppData = getCurrentUserAppData();
            const weekId = getWeekId(currentWeekStartDate);
            const pointsForWeek = (userAppData && userAppData[weekId]) ? userAppData[weekId].points : 0;

            if (pointsForWeek > 0 && pointsForWeek % rewardThreshold === 0) {
                 const rewardKey = `rewarded_${currentUserId}_${weekId}_${pointsForWeek}`; 
                 if (!localStorage.getItem(rewardKey)) {
                    showRewardNotification();
                    localStorage.setItem(rewardKey, 'true');
                 }
            }
        }

        function showRewardNotification() { 
            rewardNotification.classList.add('show');
            setTimeout(() => { rewardNotification.classList.remove('show'); }, 3000); 
        }
        
        function resetCurrentUserWeekData() {
            if (!currentUserId || !currentWeekStartDate) return;
            const userAppData = getCurrentUserAppData();
            const weekId = getWeekId(currentWeekStartDate);
            if (confirm(`Are you sure you want to reset data for THIS USER for the week of ${formatDateDisplay(currentWeekStartDate)}?`)) {
                if (userAppData[weekId]) {
                    userAppData[weekId].completionStatus = {};
                    userAppData[weekId].points = 0;
                }
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith(`rewarded_${currentUserId}_${weekId}_`)) localStorage.removeItem(key);
                });
                renderGrid(); 
                updatePointsDisplay();
                saveAllProfilesData();
            }
        }
        
        // --- Data Persistence (All Users) ---
        function saveAllProfilesData() {
            localStorage.setItem('choreApp_allProfilesData', JSON.stringify(appProfilesData));
        }
        function saveCurrentUserId() {
            if (currentUserId) {
                localStorage.setItem('choreApp_currentUserId', currentUserId);
            } else {
                localStorage.removeItem('choreApp_currentUserId');
            }
        }
        function loadAllProfilesData() {
            const loadedProfiles = localStorage.getItem('choreApp_allProfilesData');
            appProfilesData = loadedProfiles ? JSON.parse(loadedProfiles) : {};
            currentUserId = localStorage.getItem('choreApp_currentUserId'); 
        }
        
        function recalculatePointsForUserWeek(userId, weekId) {
            if (!appProfilesData[userId] || !appProfilesData[userId].appData || !appProfilesData[userId].appData[weekId]) return 0;
            
            let calculatedPoints = 0;
            const weekCompletionStatus = appProfilesData[userId].appData[weekId].completionStatus;
            for (const statusKey in weekCompletionStatus) {
                if (Object.prototype.hasOwnProperty.call(weekCompletionStatus, statusKey)) {
                    const statusValue = weekCompletionStatus[statusKey];
                    if (typeof statusValue === 'number' && statusValue >= 0 && statusValue < taskPoints.length) {
                        calculatedPoints += taskPoints[statusValue];
                    }
                }
            }
            appProfilesData[userId].appData[weekId].points = calculatedPoints;
            return calculatedPoints;
        }
        
        // --- Parent Mode & Chore Management (User Specific) ---
        let pressTimer;
        function handleTitleLongPress() { // Renamed from startPress
            showCustomModal('initialMenu');
        }
        function cancelPress(e) { clearTimeout(pressTimer); }


        function promptParentPassword() { // This is now called from the modal
            if (isParentModeActive) {
                alert("Parent mode already active.");
                return;
            }
            if (!currentUserId) {
                alert("Please select or create a user profile first.");
                return;
            }
            const password = prompt("Enter parent password (for demo, just press OK):"); // Modified prompt for demo
            if (password === PARENT_PASSWORD || PARENT_PASSWORD === "") { // Allow empty for demo
                activateParentMode();
            } else if (password !== null) {
                alert("Incorrect password.");
            }
        }

        function activateParentMode() {
            isParentModeActive = true;
            document.body.classList.add('parent-mode-active');
            toggleParentModeUIElements();
            renderEditableChoresListForCurrentUser(); 
        }
        function deactivateParentMode() {
            isParentModeActive = false;
            document.body.classList.remove('parent-mode-active');
            toggleParentModeUIElements();
            resetChoreForm();
        }
        function toggleParentModeUIElements() {
            parentControlsSection.style.display = isParentModeActive ? 'flex' : 'none';
            const deleteButtonsInGrid = document.querySelectorAll('.delete-chore-btn');
            deleteButtonsInGrid.forEach(btn => {
                if (btn) btn.style.display = isParentModeActive ? 'block' : 'none';
            });
        }

        function renderEditableChoresListForCurrentUser() {
            editableChoresListContainer.innerHTML = '';
            const userChores = getCurrentUserChores();
            if (!userChores || userChores.length === 0) {
                editableChoresListContainer.innerHTML = '<p style="text-align:center; color: var(--text-dark);">No chores defined for this user yet.</p>';
                return;
            }
            userChores.forEach(chore => {
                const item = document.createElement('div');
                item.classList.add('editable-chore-item');
                item.innerHTML = `
                    <span>${getChoreIconHTML(chore)} ${chore.name}</span>
                    <button data-chore-id="${chore.id}">Edit</button>
                `;
                item.querySelector('button').addEventListener('click', () => populateChoreFormForEdit(chore.id));
                editableChoresListContainer.appendChild(item);
            });
        }

        function populateChoreFormForEdit(choreId) {
            const userChores = getCurrentUserChores();
            const choreToEdit = userChores.find(c => c.id === choreId);
            if (!choreToEdit) return;

            editingChoreId = choreId;
            newChoreNameInput.value = choreToEdit.name;
            newChoreIconTypeInput.value = choreToEdit.iconType;
            newChoreIconValueInput.value = choreToEdit.iconValue;

            saveChoreButton.textContent = 'Update Chore';
            cancelEditChoreButton.style.display = 'block';
            choreFormButtonsContainer.classList.add('two-buttons');
        }

        function resetChoreForm() {
            editingChoreId = null;
            newChoreNameInput.value = '';
            newChoreIconTypeInput.value = 'emoji';
            newChoreIconValueInput.value = '';
            saveChoreButton.textContent = 'Add Chore';
            cancelEditChoreButton.style.display = 'none';
            choreFormButtonsContainer.classList.remove('two-buttons');
        }

        saveChoreButton.addEventListener('click', () => {
            if (!currentUserId) {
                alert("No active user. Cannot save chore."); return;
            }
            const userChores = getCurrentUserChores();
            const name = newChoreNameInput.value.trim();
            const iconType = newChoreIconTypeInput.value;
            const iconValue = newChoreIconValueInput.value.trim();

            if (!name || !iconValue) {
                alert("Please enter chore name and icon value."); return;
            }
            if (iconType === 'svg' && !svgIcons[iconValue]) {
                alert(`SVG key "${iconValue}" not recognized.`); return;
            }

            if (editingChoreId) { 
                const choreToUpdate = userChores.find(c => c.id === editingChoreId);
                if (choreToUpdate) {
                    choreToUpdate.name = name;
                    choreToUpdate.iconType = iconType;
                    choreToUpdate.iconValue = iconValue;
                }
            } else { 
                const newChore = {
                    id: name.toLowerCase().replace(/\s+/g, '_') + '_' + Date.now(), 
                    name: name, iconType: iconType, iconValue: iconValue
                };
                userChores.push(newChore);
            }
            
            resetChoreForm();
            renderGrid(); 
            renderEditableChoresListForCurrentUser();
            saveAllProfilesData();
        });
        
        cancelEditChoreButton.addEventListener('click', resetChoreForm);

        function deleteChoreForCurrentUser(choreIdToDelete) {
            if (!currentUserId) return;
            const userProfile = getCurrentUserProfile();
            const choreDefToDelete = userProfile.chores.find(c => c.id === choreIdToDelete);

            if (!choreDefToDelete || !confirm(`Are you sure you want to delete "${choreDefToDelete.name}" for THIS USER? Data for this chore will be removed from all their weeks.`)) {
                return;
            }
            userProfile.chores = userProfile.chores.filter(chore => chore.id !== choreIdToDelete);
            
            for (const weekId_loop in userProfile.appData) { 
                if (userProfile.appData[weekId_loop] && userProfile.appData[weekId_loop].completionStatus) {
                    let weekModified = false;
                    Object.keys(userProfile.appData[weekId_loop].completionStatus).forEach(key => {
                        if (key.startsWith(choreIdToDelete + '_')) {
                            delete userProfile.appData[weekId_loop].completionStatus[key];
                            weekModified = true;
                        }
                    });
                    if (weekModified) recalculatePointsForUserWeek(currentUserId, weekId_loop);
                }
            }
            if (editingChoreId === choreIdToDelete) resetChoreForm();
            
            renderGrid(); 
            renderEditableChoresListForCurrentUser();
            updatePointsDisplay();
            saveAllProfilesData();
        }

        // --- User Switching and Creation (Modal based) ---
        function switchUser(userIdToSwitchTo) { // Called from modal user list
            if (appProfilesData[userIdToSwitchTo]) {
                if (isParentModeActive) deactivateParentMode(); 
                currentUserId = userIdToSwitchTo;
                loadUser(currentUserId); 
                // hideCustomModal(); // Already handled by click listener in populateModalUserList
            } else {
                alert("User not found.");
            }
        }
        
        function handleCreateNewUserFromModal() { // Called from modal form
            const profileName = modalNewUserNameInput.value.trim();
            if (!profileName) {
                alert("Profile name cannot be empty.");
                modalNewUserNameInput.focus();
                return;
            }

            const nameExists = Object.values(appProfilesData).some(p => p.profileName === profileName);
            if (nameExists) {
                if (!confirm(`A profile named "${profileName}" already exists. Create another one with this name?`)){
                    return;
                }
            }

            const newUserId = 'user_' + Date.now();
            appProfilesData[newUserId] = {
                profileName: profileName,
                chores: JSON.parse(JSON.stringify(initialChoresDefinitionsTemplate)), 
                appData: {} 
            };
            
            if (isParentModeActive) deactivateParentMode(); 
            switchUser(newUserId); // This calls loadUser
            saveAllProfilesData(); 
            alert(`User profile "${profileName}" created!`);
            modalNewUserNameInput.value = ''; 
            hideCustomModal();
        }
        
        // --- Event Listeners Setup ---
        // Title Long Press
        pageTitleElement.addEventListener('mousedown', (e) => {
            if (e.type === 'mousedown' && e.button !== 0) return; 
            pressTimer = window.setTimeout(handleTitleLongPress, 50);
        });
        pageTitleElement.addEventListener('touchstart', (e) => {
            e.preventDefault();
            pressTimer = window.setTimeout(handleTitleLongPress, 1000);
        }, { passive: false });
        pageTitleElement.addEventListener('mouseup', cancelPress);
        pageTitleElement.addEventListener('mouseleave', cancelPress); 
        pageTitleElement.addEventListener('touchend', cancelPress);
        pageTitleElement.addEventListener('touchcancel', cancelPress); 

        // Modal Buttons
        modalCloseButton.addEventListener('click', hideCustomModal);
        customModalOverlay.addEventListener('click', (event) => { 
            if (event.target === customModalOverlay) {
                hideCustomModal();
            }
        });
        modalParentModeBtn.addEventListener('click', () => {
            hideCustomModal(); 
            promptParentPassword(); 
        });
        modalSwitchUserBtn.addEventListener('click', () => {
            showCustomModal('userManagement');
        });
        modalShowCreateUserFormBtn.addEventListener('click', () => {
            showCustomModal('newUserFormWithinManagement');
        });
        modalConfirmCreateUserBtn.addEventListener('click', handleCreateNewUserFromModal);
        modalCancelCreateUserBtn.addEventListener('click', () => {
            modalNewUserForm.style.display = 'none'; 
            modalNewUserNameInput.value = '';       
            showCustomModal('userManagement'); 
        });

        // Other Controls
        exitParentModeButton.addEventListener('click', deactivateParentMode);
        
        function updateToggleViewButtonText() { 
            if (!currentUserId) {
                toggleViewButton.disabled = true;
                toggleViewButton.textContent = "N/A (No User)";
                return;
            }
             if (isCurrentRealWeek()) {
                toggleViewButton.disabled = false;
                toggleViewButton.textContent = currentView === 'weekly' ? "Switch to Today's View" : 'Switch to Full Week View';
            } else {
                toggleViewButton.disabled = true; 
                toggleViewButton.textContent = "Full Week View (Past/Future)";
                if (currentView === 'daily') currentView = 'weekly'; 
            }
        }
        function toggleView() { 
            if (!currentUserId || !isCurrentRealWeek()) return; 
            currentView = (currentView === 'weekly') ? 'daily' : 'weekly';
            updateToggleViewButtonText();
            renderGrid();
        }
        toggleViewButton.addEventListener('click', toggleView);

        prevWeekButton.addEventListener('click', () => { 
            if (!currentUserId || !currentWeekStartDate) return;
            const newStartDate = new Date(currentWeekStartDate);
            newStartDate.setDate(currentWeekStartDate.getDate() - 7);
            navigateToWeek(newStartDate);
        });
        nextWeekButton.addEventListener('click', () => { 
            if (!currentUserId || !currentWeekStartDate) return;
            const newStartDate = new Date(currentWeekStartDate);
            newStartDate.setDate(currentWeekStartDate.getDate() + 7);
            navigateToWeek(newStartDate);
        });

        downloadDataButton.addEventListener('click', () => {
            const dataToBackup = {
                appProfilesData: appProfilesData, 
                currentUserId: currentUserId 
            };
            const jsonString = JSON.stringify(dataToBackup, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'all_users_chore_data.json';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url); alert("All users' chore data download initiated!");
        });
        uploadDataButton.addEventListener('click', () => { uploadFileInput.click(); });
        uploadFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedFullData = JSON.parse(e.target.result);
                    if (loadedFullData && typeof loadedFullData.appProfilesData === 'object') {
                        appProfilesData = loadedFullData.appProfilesData;
                        currentUserId = loadedFullData.currentUserId || null; 
                        
                        for (const userId_loop in appProfilesData) { 
                            if (appProfilesData[userId_loop] && appProfilesData[userId_loop].appData) { 
                                for (const weekId_loop in appProfilesData[userId_loop].appData) { 
                                    recalculatePointsForUserWeek(userId_loop, weekId_loop);
                                }
                            }
                        }
                        
                        Object.keys(localStorage).forEach(key => { 
                             if (key.startsWith(`rewarded_`)) localStorage.removeItem(key);
                        });

                        saveAllProfilesData(); 
                        saveCurrentUserId();

                        let userToLoadAfterUpload = null;
                        if (currentUserId && appProfilesData[currentUserId]) {
                            userToLoadAfterUpload = currentUserId;
                        } else if (Object.keys(appProfilesData).length > 0) {
                            userToLoadAfterUpload = Object.keys(appProfilesData)[0];
                        }

                        if (userToLoadAfterUpload) {
                            loadUser(userToLoadAfterUpload);
                        } else {
                            currentUserId = null; 
                            saveCurrentUserId();
                            pageTitleElement.textContent = "User's Chores";
                            choreGridBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">Data loaded, but no valid user profile found. Please create a new user.</td></tr>';
                            totalPointsDisplay.textContent = "0";
                            if(editableChoresListContainer) editableChoresListContainer.innerHTML = ''; 
                            showCustomModal('userManagement'); // Guide to create user
                        }
                        alert("All users' data loaded successfully!");
                    } else {
                        alert("Invalid data file format. Expected 'appProfilesData' object.");
                    }
                } catch (error) {
                    alert("Error reading or parsing file: " + error.message);
                } finally {
                    uploadFileInput.value = null; 
                }
            };
            reader.readAsText(file);
        });
        resetWeekButton.addEventListener('click', resetCurrentUserWeekData);
        
        // --- Initialize ---
        initApp();
    </script>
</body>
</html>