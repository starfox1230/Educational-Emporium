<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matilda's Room Jobs</title>
    <style>
        :root {
            --page-bg: #F0E6FF; /* Lightest lavender for overall page */
            --title-purple: #5D3A9B;
            --header-bg: #DCD0FF; /* Table header (MON, TUE...) background */
            --chore-col-bg: #EAE0FF; /* First column (chore names) background */
            --cell-bg: #F8F0FF; /* Data cell background */
            --grid-border: #BEA6E0;
            --text-dark: #4A2E87;
            --icon-color: #785A9B; /* For SVG icons if used */
            --accent-color: #9B59B6; /* For buttons, highlights */
            --completed-bounce: bounce-effect 0.3s ease;
            --button-subtle-bg: #EAE0FF;
            --button-subtle-hover-bg: #DCD0FF;
            --button-subtle-text: var(--title-purple);
        }

        @keyframes bounce-effect {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        @keyframes sparkle-effect {
            0% { opacity: 1; transform: scale(0) rotate(0deg); }
            50% { opacity: 0.8; transform: scale(1.5) rotate(180deg); }
            100% { opacity: 0; transform: scale(0) rotate(360deg); }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--page-bg);
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: var(--page-bg); 
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        header h1#page-title { 
            font-family: Georgia, 'Times New Roman', Times, serif;
            color: var(--title-purple);
            text-align: center;
            font-size: 2.8em;
            margin-bottom: 15px; /* Reduced margin */
            cursor: default; 
            user-select: none; 
            -webkit-user-select: none; 
            -moz-user-select: none; 
            -ms-user-select: none; 
            -webkit-touch-callout: none; 
        }

        .week-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 5px 0;
            border-bottom: 1px solid var(--grid-border);
            border-top: 1px solid var(--grid-border);
        }

        .week-navigation button {
            background-color: var(--button-subtle-bg);
            color: var(--button-subtle-text);
            border: 1px solid var(--grid-border);
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
        }
        .week-navigation button:hover {
            background-color: var(--button-subtle-hover-bg);
        }
        .week-navigation span#week-dates-display {
            font-size: 1.1em;
            color: var(--title-purple);
            font-weight: bold;
            text-align: center;
            flex-grow: 1;
        }


        .chore-chart-wrapper {
            background-color: var(--chore-col-bg); 
            border-radius: 10px;
            overflow: hidden; 
            border: 1px solid var(--grid-border);
        }
        
        .chore-chart table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .chore-chart th, .chore-chart td {
            border: 1px solid var(--grid-border);
            text-align: center;
            padding: 8px;
            height: 70px; 
            box-sizing: border-box;
        }

        .chore-chart th {
            background-color: var(--header-bg);
            color: var(--title-purple);
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .chore-chart th.chore-header-cell { 
             background-color: var(--chore-col-bg);
             /* border-top-left-radius: 10px; remove if week nav has top border */
        }
        .chore-chart th.day-header-cell:last-of-type { 
             /* border-top-right-radius: 10px; remove if week nav has top border*/
        }


        .chore-chart td.chore-label-cell {
            background-color: var(--chore-col-bg);
            font-weight: bold;
            font-size: 0.9em;
            color: var(--title-purple);
            padding: 5px;
            vertical-align: middle;
            position: relative; 
        }
        
        .chore-label-cell .chore-item-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .chore-label-cell .chore-icon-svg svg { 
            width: 32px;
            height: 32px;
            fill: var(--icon-color);
        }
        .chore-label-cell .chore-icon-emoji { 
             font-size: 32px; 
        }
        
        .chore-label-cell .chore-name {
            font-size: 0.9em;
        }

        .chore-chart td.task-cell {
            background-color: var(--cell-bg);
            cursor: pointer;
            font-size: 1.8em; 
            transition: background-color 0.2s ease;
            position: relative; 
        }

        .chore-chart td.task-cell:hover {
            background-color: #e8dfff;
        }
        
        .chore-chart tr:last-child td:first-child.chore-label-cell {
            border-bottom-left-radius: 10px;
        }
        .chore-chart tr:last-child td:last-of-type.task-cell { 
             border-bottom-right-radius: 10px;
        }

        .sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: gold;
            border-radius: 50%;
            pointer-events: none;
            animation: sparkle-effect 0.6s forwards;
        }

        .controls {
            text-align: center;
            margin-top: 25px;
            display: flex;
            gap: 10px;
            justify-content: center; 
            align-items: center;
            flex-wrap: wrap;
        }
         .controls > * { 
            margin-right: 10px; 
        }
        .controls > *:last-child {
            margin-right: 0;
        }
        .controls p {
             flex-grow: 1; 
             text-align: center; 
        }


        .controls button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px; 
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em; 
            transition: background-color 0.2s ease;
            white-space: nowrap; 
        }

        .controls button:hover {
            background-color: #8E44AD;
        }
        
        .parent-controls { 
            display: none; 
            flex-direction: column;
            gap: 15px; 
            margin-top: 15px;
            padding: 15px;
            border: 1px dashed var(--accent-color);
            border-radius: 8px;
            background-color: #fdfaff;
        }

        .parent-controls .parent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 10px;
            align-items: center;
        }
        
        .parent-mode-active .parent-controls {
            display: flex; 
        }

        .parent-controls input[type="text"], .parent-controls select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--grid-border);
            box-sizing: border-box;
            width: 100%; 
        }
        
        .parent-controls button {
            padding: 10px 15px;
            font-size: 0.9em;
            background-color: var(--accent-color); 
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
        }
        .parent-controls button:hover {
            background-color: #8E44AD; 
        }

        .parent-controls button.button-subtle {
            background-color: var(--button-subtle-bg);
            color: var(--button-subtle-text);
            border: 1px solid var(--grid-border);
        }
        .parent-controls button.button-subtle:hover {
            background-color: var(--button-subtle-hover-bg);
        }

        .parent-controls .io-buttons-grid { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .delete-chore-btn {
            display: none; 
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
        }
        
        .parent-mode-active .delete-chore-btn {
            display: block; 
        }


        #reward-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2ECC71;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-size: 1.2em;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s, top 0.5s;
        }

        #reward-notification.show {
            opacity: 1;
            visibility: visible;
            top: 50px;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            header h1#page-title { font-size: 2.2em; margin-bottom: 15px; }
            .week-navigation span#week-dates-display { font-size: 1em; }
            .week-navigation button { padding: 6px 10px; font-size: 0.8em;}
            .chore-chart th, .chore-chart td { padding: 6px; height: 60px; }
            .chore-chart th { font-size: 0.75em; }
            .chore-label-cell .chore-icon-svg svg { width: 24px; height: 24px;}
            .chore-label-cell .chore-icon-emoji { font-size: 24px; }
            .chore-label-cell .chore-name { font-size: 0.8em; }
            .chore-chart td.task-cell { font-size: 1.5em; }
            .controls button { padding: 8px 12px; font-size: 0.85em; }
             .parent-controls .parent-grid { grid-template-columns: 1fr; } 
        }
        @media (max-width: 480px) {
            header h1#page-title { font-size: 1.8em; }
            .week-navigation { flex-wrap: wrap; justify-content: center; }
            .week-navigation span#week-dates-display { font-size: 0.9em; order: -1; width: 100%; margin-bottom: 5px;}
            .week-navigation button { padding: 5px 8px; font-size: 0.75em;}
            .chore-chart th { font-size: 0.6em; } 
            .chore-label-cell .chore-icon-svg svg { width: 20px; height: 20px;}
            .chore-label-cell .chore-icon-emoji { font-size: 20px; }
            .chore-label-cell .chore-name { font-size: 0.7em; }
            .chore-chart td.task-cell { font-size: 1.2em; }
            .chore-chart td, .chore-chart th { padding: 4px; height: 50px;}
            .chore-chart-wrapper {overflow-x: auto;} 
            .chore-chart table {min-width: 320px;} 
            .controls { 
                flex-direction: row; 
                justify-content: space-around; 
             }
            .controls button { width: auto; flex-shrink: 0;}
            .controls p { margin: 5px 0; text-align: center; flex-grow: 0;} 
            .parent-controls .parent-grid, .parent-controls .io-buttons-grid { grid-template-columns: 1fr; } 
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="page-title">MATILDA'S ROOM JOBS</h1>
        </header>
        <main>
            <div class="week-navigation">
                <button id="prev-week-button">< Prev Week</button>
                <span id="week-dates-display"></span>
                <button id="next-week-button">Next Week ></button>
            </div>

            <div class="chore-chart-wrapper">
                <div class="chore-chart">
                    <table>
                        <thead>
                            <tr id="chore-chart-header-row">
                            </tr>
                        </thead>
                        <tbody id="chore-grid-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="controls">
                <button id="toggle-view-button">Switch to Today's View</button>
                <p>Points This Week: <span id="total-points">0</span></p>
            </div>
            
            <div class="parent-controls" id="parent-controls-section">
                <h3>Parent Mode</h3>
                <div> 
                    <div class="parent-grid">
                        <input type="text" id="new-chore-name" placeholder="New chore name">
                        <select id="new-chore-icon-type">
                            <option value="emoji">Emoji</option>
                            <option value="svg">SVG (Preset Key)</option>
                        </select>
                        <input type="text" id="new-chore-icon-value" placeholder="Emoji (e.g. ✨) or SVG key">
                    </div>
                    <button id="add-chore-button" style="margin-top: 10px;">Add Chore</button>
                </div>
                
                <div class="io-buttons-grid"> 
                    <button id="download-data-button">Download Data</button>
                    <button id="upload-data-button">Upload Data</button>
                    <input type="file" id="upload-file-input" accept=".json" style="display: none;">
                </div>
                <button id="reset-week-button" class="button-subtle">Reset THIS Week</button>
                <button id="exit-parent-mode-button">Exit Parent Mode</button>
            </div>

        </main>
    </div>

    <div id="reward-notification">
        🎉 You earned a reward! Keep up the great work! ⭐
    </div>

    <script>
        const choreGridBody = document.getElementById('chore-grid-body');
        const choreChartHeaderRow = document.getElementById('chore-chart-header-row');
        const resetWeekButton = document.getElementById('reset-week-button');
        const toggleViewButton = document.getElementById('toggle-view-button');
        const totalPointsDisplay = document.getElementById('total-points');
        const rewardNotification = document.getElementById('reward-notification');
        const pageTitle = document.getElementById('page-title');
        const parentControlsSection = document.getElementById('parent-controls-section');
        const addChoreButton = document.getElementById('add-chore-button');
        const newChoreNameInput = document.getElementById('new-chore-name');
        const newChoreIconTypeInput = document.getElementById('new-chore-icon-type');
        const newChoreIconValueInput = document.getElementById('new-chore-icon-value');
        const exitParentModeButton = document.getElementById('exit-parent-mode-button');
        const downloadDataButton = document.getElementById('download-data-button');
        const uploadDataButton = document.getElementById('upload-data-button');
        const uploadFileInput = document.getElementById('upload-file-input');
        const prevWeekButton = document.getElementById('prev-week-button');
        const nextWeekButton = document.getElementById('next-week-button');
        const weekDatesDisplay = document.getElementById('week-dates-display');

        const PARENT_PASSWORD = ""; 
        let isParentModeActive = false;
        let currentView = 'weekly'; // 'weekly' or 'daily'

        const svgIcons = { 
            stuffies_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c2.481 0 4.5-2.019 4.5-4.5S18.981 3 16.5 3C14.02 3 12 5.019 12 7.5c0 .88.25 1.691.681 2.385C11.625 9.319 10.5 8.458 10.5 7.5 10.5 5.019 8.481 3 6 3S1.5 5.019 1.5 7.5c0 .958.625 1.819 1.681 2.385C3.25 10.691 3 11.5 3 12.375c0 2.306 1.001 4.363 2.626 5.752C6.042 19.046 7.5 21 7.5 21h9s1.458-1.954 1.874-2.873C20.001 16.738 21 14.681 21 12.375c0-.875-.25-1.681-.681-2.385.944-.548 1.681-1.473 1.681-2.49C22 6.019 19.981 4 17.5 4S13 6.019 13 8.5c0 .958.625 1.819 1.681 2.385C14.75 11.691 14.5 12.5 14.5 13.375c0 1.422.499 2.729 1.32 3.768.091.112.185.222.28.332H7.9c.095-.11.189-.22.28-.332.821-1.039 1.32-2.346 1.32-3.768 0-.875-.25-1.681-.681-2.385C9.769 10.319 10.5 9.458 10.5 8.5 10.5 7.078 9.422 6 8 6S5.5 7.078 5.5 8.5c0 .958.625 1.819 1.681 2.385C7.25 11.691 7 12.5 7 13.375c0 1.763.708 3.35 1.846 4.52L7.5 20l-1.346-2.107A5.98 5.98 0 0 1 4.5 13.375C4.5 12.5 4.75 11.691 5.181 11C4.237 10.452 3.5 9.527 3.5 8.5 3.5 6.019 5.519 4 8 4s4.5 2.019 4.5 4.5c0 .958-.625 1.819-1.681 2.385C10.75 10.691 11 11.5 11 12.375c0 .479-.073.941-.209 1.381.711.301 1.36.713 1.909 1.232.55-.519 1.199-.931 1.909-1.232C14.427 13.316 14.354 12.854 14.354 12.375 14.354 11.5 14.604 10.691 15.035 11c-.944-.548-1.681-1.473-1.681-2.49C13.354 7.078 14.432 6 15.854 6s2.5 1.078 2.5 2.5c0 .958-.625 1.819-1.681 2.385C16.604 10.691 16.854 11.5 16.854 12.375c0 .479-.073.941-.209 1.381.711.301 1.36.713 1.909 1.232.55-.519 1.199-.931 1.909-1.232C19.927 13.316 19.854 12.854 19.854 12.375c0-.875.25-1.681.681-2.385.944-.548 1.681-1.473 1.681-2.49C20.354 6.019 18.335 4 15.854 4c-1.422 0-2.5.922-2.5 2.344V7.5c0 .88.25 1.691.681 2.385.001 0 .001 0 .001 0h.001C14.035 10.309 14.035 10.309 14.035 10.309zM8 18H6v-2h2v2zm8 0h-2v-2h2v2z"></path></svg>',
            dolls_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 5.5A3.5 3.5 0 0 0 8.5 9H7a5 5 0 0 1 10 0h-1.5a3.5 3.5 0 0 0-3.5-3.5zM12 14c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>',
            books_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V5h10v6z"/></svg>',
            dirty_clothes_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.5 6C18.5 5.17 17.83 4.5 17 4.5H14.82C14.4 3.34 13.3 2.5 12 2.5S9.6 3.34 9.18 4.5H7C6.17 4.5 5.5 5.17 5.5 6V7H4V19.5C4 20.33 4.67 21 5.5 21H18.5C19.33 21 20 20.33 20 19.5V7H18.5V6ZM12 4.5C12.55 4.5 13 4.95 13 5.5V6H11V5.5C11 4.95 11.45 4.5 12 4.5ZM18 19H6V9H18V19Z"/></svg>',
            house_toys_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>',
            medical_toys_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.11 0-1.99.89-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.11-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z"/></svg>',
            mystery_things_svg: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v2h-2zm0 4h2v6h-2z"/></svg>'
        };
        
        const initialChoresDefinitions = [ 
            { id: 'stuffies', name: 'Stuffies', iconType: 'emoji', iconValue: '🧸' }, 
            { id: 'dolls', name: 'Dolls', iconType: 'emoji', iconValue: '🎀' },     
            { id: 'books', name: 'Books', iconType: 'emoji', iconValue: '📚' },      
            { id: 'dirty_clothes', name: 'Dirty Clothes', iconType: 'emoji', iconValue: '🧺' }, 
            { id: 'house_toys', name: 'House Toys', iconType: 'emoji', iconValue: '🏠' }, 
            { id: 'medical_toys', name: 'Medical Toys', iconType: 'emoji', iconValue: '🩹' },
            { id: 'mystery_things', name: 'Mystery Things', iconType: 'emoji', iconValue: '📦' } 
        ];

        let chores = []; // Holds chore definitions
        let appData = {}; // Holds all weekly data: appData[weekId] = { completionStatus: {}, points: 0 }
        let currentWeekStartDate = null; // Date object for Sunday of the current week

        const rewardThreshold = 28; 
        const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        const taskIcons = ['', '✔️', '🌟', '💖'];
        const taskPoints = [0, 1, 2, 3];


        // --- Date Helper Functions ---
        function getWeekStartDate(d) {
            const date = new Date(d);
            const day = date.getDay(); // 0 for Sunday, 1 for Monday, ...
            const diff = date.getDate() - day;
            return new Date(date.setDate(diff));
        }

        function getWeekEndDate(d) {
            const startDate = getWeekStartDate(d);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            return endDate;
        }

        function formatDateDisplay(date) { // For month-day display
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        function getWeekId(date) { // Creates YYYY-MM-DD string for the start of the week (Sunday)
            const d = new Date(date);
            d.setHours(0,0,0,0); // Normalize time
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        function isCurrentRealWeek() {
            const today = new Date();
            const startOfThisRealWeek = getWeekStartDate(today);
            return isSameDay(currentWeekStartDate, startOfThisRealWeek);
        }

        // --- Core Logic ---
        function initApp() {
            loadChoresDefinitions();
            loadAppData();
            const today = new Date();
            navigateToWeek(getWeekStartDate(today)); // Navigate to current week
            deactivateParentMode();
        }
        
        function navigateToWeek(targetStartDate) {
            currentWeekStartDate = getWeekStartDate(targetStartDate); // Ensure it's always a Sunday
            currentWeekStartDate.setHours(0,0,0,0); // Normalize time for consistency

            const weekId = getWeekId(currentWeekStartDate);

            if (!appData[weekId]) {
                appData[weekId] = { completionStatus: {}, points: 0 };
            }
            
            updateWeekDateDisplay();
            updateToggleViewButtonText();
            renderGrid(); // This will use data from appData[weekId]
            updatePointsDisplay(); // This will use data from appData[weekId]
        }

        function updateWeekDateDisplay() {
            const startDate = currentWeekStartDate;
            const endDate = getWeekEndDate(startDate);
            weekDatesDisplay.textContent = `${formatDateDisplay(startDate)} - ${formatDateDisplay(endDate)}`;
        }
        
        function getChoreIconHTML(chore) {
            if (chore.iconType === 'emoji') {
                return `<span class="chore-icon-emoji">${chore.iconValue}</span>`;
            } else if (chore.iconType === 'svg' && svgIcons[chore.iconValue]) {
                return `<div class="chore-icon-svg">${svgIcons[chore.iconValue]}</div>`;
            }
            return `<span class="chore-icon-emoji">❓</span>`; 
        }

        function renderGrid() {
            choreChartHeaderRow.innerHTML = '';
            choreGridBody.innerHTML = '';

            const weekId = getWeekId(currentWeekStartDate);
            const currentWeekData = appData[weekId] || { completionStatus: {}, points: 0 };
            const weekCompletionStatus = currentWeekData.completionStatus;

            let daysToDisplayConfig = days.map((day, index) => ({ name: day, index: index }));

            if (currentView === 'daily' && isCurrentRealWeek()) {
                const todayRealDate = new Date();
                const todayDayIndex = todayRealDate.getDay(); // 0 for Sun, 1 for Mon...
                daysToDisplayConfig = [{ name: days[todayDayIndex], index: todayDayIndex }];
            }
            // If currentView is 'daily' but not isCurrentRealWeek(), it shows all 7 days of that selected week.

            const emptyHeaderCell = document.createElement('th');
            emptyHeaderCell.classList.add('chore-header-cell');
            choreChartHeaderRow.appendChild(emptyHeaderCell);

            daysToDisplayConfig.forEach(dayConfig => {
                const dayHeaderCell = document.createElement('th');
                dayHeaderCell.classList.add('day-header-cell');
                dayHeaderCell.textContent = dayConfig.name;
                choreChartHeaderRow.appendChild(dayHeaderCell);
            });

            chores.forEach(chore => {
                const row = document.createElement('tr');
                row.dataset.choreId = chore.id;
                const labelCell = document.createElement('td');
                labelCell.classList.add('chore-label-cell');
                labelCell.innerHTML = `
                    <div class="chore-item-content">
                        ${getChoreIconHTML(chore)}
                        <span class="chore-name">${chore.name}</span>
                    </div>
                    <button class="delete-chore-btn" data-chore-id="${chore.id}">X</button>
                `;
                row.appendChild(labelCell);
                
                const deleteBtn = labelCell.querySelector('.delete-chore-btn');
                if (deleteBtn) {
                    deleteBtn.style.display = isParentModeActive ? 'block' : 'none'; // Initial state
                    deleteBtn.onclick = () => deleteChore(chore.id);
                }


                daysToDisplayConfig.forEach(dayConfig => {
                    const dayIndex = dayConfig.index;
                    const cell = document.createElement('td');
                    cell.classList.add('task-cell');
                    cell.dataset.choreId = chore.id;
                    cell.dataset.dayIndex = dayIndex; // This dayIndex is 0-6 within its week
                    
                    const statusKey = `${chore.id}_${dayIndex}`;
                    const currentStatus = weekCompletionStatus[statusKey] || 0;
                    cell.innerHTML = taskIcons[currentStatus];
                    if (currentStatus > 0) cell.style.animation = 'none';
                    
                    cell.addEventListener('click', () => handleTaskClick(cell, chore.id, dayIndex));
                    row.appendChild(cell);
                });
                choreGridBody.appendChild(row);
            });
            toggleParentModeUI(); // Ensures delete buttons are correctly shown/hidden after render
        }
        
        function handleTaskClick(cell, choreId, dayIndex) {
            const weekId = getWeekId(currentWeekStartDate);
            if (!appData[weekId]) { // Should not happen if navigateToWeek initializes correctly
                appData[weekId] = { completionStatus: {}, points: 0 };
            }
            
            const statusKey = `${choreId}_${dayIndex}`;
            let oldStatus = appData[weekId].completionStatus[statusKey] || 0;
            const pointsForOldStatus = taskPoints[oldStatus];

            let newStatus = (oldStatus + 1) % taskIcons.length;
            appData[weekId].completionStatus[statusKey] = newStatus;
            cell.innerHTML = taskIcons[newStatus];
            const pointsForNewStatus = taskPoints[newStatus];

            appData[weekId].points -= pointsForOldStatus;
            appData[weekId].points += pointsForNewStatus;
            
            cell.style.animation = 'none'; 
            void cell.offsetWidth; 
            cell.style.animation = 'var(--completed-bounce)'; 
            if (newStatus > 0) {
                createSparkles(cell);
            }
            updatePointsDisplay(); // Uses appData[weekId].points
            checkReward(); // Uses appData[weekId].points for currentPoints
            saveAllData();
        }

        function createSparkles(cell) {
            for (let i = 0; i < 5; i++) { 
                const sparkle = document.createElement('div');
                sparkle.classList.add('sparkle');
                sparkle.style.left = `${Math.random() * 80 + 10}%`; 
                sparkle.style.top = `${Math.random() * 80 + 10}%`;
                sparkle.style.backgroundColor = ['gold', 'lightpink', 'lightblue'][Math.floor(Math.random() * 3)];
                cell.appendChild(sparkle);
                setTimeout(() => sparkle.remove(), 600); 
            }
        }

        function updatePointsDisplay() {
            const weekId = getWeekId(currentWeekStartDate);
            const pointsForWeek = appData[weekId] ? appData[weekId].points : 0;
            totalPointsDisplay.textContent = pointsForWeek;
        }

        function checkReward() {
            const weekId = getWeekId(currentWeekStartDate);
            const pointsForWeek = appData[weekId] ? appData[weekId].points : 0;

            if (pointsForWeek > 0 && pointsForWeek % rewardThreshold === 0) {
                 const lastRewardedPoints = parseInt(localStorage.getItem('matildaLastRewardedPoints') || '0');
                 // Make reward notification specific to not re-trigger for same point value if user navigates away and back
                 const rewardKey = `rewarded_${weekId}_${pointsForWeek}`; 
                 if (pointsForWeek > lastRewardedPoints && !localStorage.getItem(rewardKey)) {
                    showRewardNotification();
                    localStorage.setItem('matildaLastRewardedPoints', pointsForWeek.toString()); // Still track highest point for overall reward
                    localStorage.setItem(rewardKey, 'true'); // Mark this specific week/point combo as rewarded
                 }
            }
        }

        function showRewardNotification() {
            rewardNotification.classList.add('show');
            setTimeout(() => {
                rewardNotification.classList.remove('show');
            }, 3000); 
        }
        
        function resetCurrentWeekData() {
            const weekId = getWeekId(currentWeekStartDate);
            if (confirm(`Are you sure you want to reset data for the week of ${formatDateDisplay(currentWeekStartDate)}? All progress for THIS week will be lost.`)) {
                if (appData[weekId]) {
                    appData[weekId].completionStatus = {};
                    appData[weekId].points = 0;
                }
                // Remove any week-specific reward flags for this week
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith(`rewarded_${weekId}_`)) {
                        localStorage.removeItem(key);
                    }
                });
                // We don't reset matildaLastRewardedPoints here, as that's a global high score for rewards.
                renderGrid(); // Re-render with 0s
                updatePointsDisplay();
                saveAllData();
            }
        }
        
        function saveAllData() {
            localStorage.setItem('matildaChoresDefinitions', JSON.stringify(chores));
            localStorage.setItem('matildaAppData', JSON.stringify(appData));
        }

        function loadChoresDefinitions() {
            const loadedChores = localStorage.getItem('matildaChoresDefinitions');
            if (loadedChores) {
                chores = JSON.parse(loadedChores);
            } else {
                chores = JSON.parse(JSON.stringify(initialChoresDefinitions)); 
            }
        }
        function loadAppData() {
            const loadedAppData = localStorage.getItem('matildaAppData');
            if (loadedAppData) {
                appData = JSON.parse(loadedAppData);
                // Optional: Iterate through appData and recalculate points if taskPoints changed
                // For now, assume stored points are correct.
            } else {
                appData = {};
            }
        }
        
        function recalculatePointsForWeek(weekId) {
            if (!appData[weekId] || !appData[weekId].completionStatus) return 0;

            let calculatedPoints = 0;
            const weekCompletionStatus = appData[weekId].completionStatus;
            for (const statusKey in weekCompletionStatus) {
                if (Object.prototype.hasOwnProperty.call(weekCompletionStatus, statusKey)) {
                    const statusValue = weekCompletionStatus[statusKey];
                    if (typeof statusValue === 'number' && statusValue >= 0 && statusValue < taskPoints.length) {
                        calculatedPoints += taskPoints[statusValue];
                    }
                }
            }
            appData[weekId].points = calculatedPoints;
            return calculatedPoints;
        }
        
        let pressTimer;
        function startPress(e) {
            if (e.type === 'touchstart') e.preventDefault();
            pressTimer = window.setTimeout(promptParentPassword, 2000); 
        }
        function cancelPress(e) { clearTimeout(pressTimer); }
        
        function promptParentPassword() {
            if (isParentModeActive) return;
            const password = prompt("Enter parent password:");
            if (password === PARENT_PASSWORD) activateParentMode();
            else if (password !== null) alert("Incorrect password.");
        }

        function activateParentMode() {
            isParentModeActive = true;
            document.body.classList.add('parent-mode-active');
            toggleParentModeUI(); // Update UI immediately
        }
        
        function deactivateParentMode() {
            isParentModeActive = false;
            document.body.classList.remove('parent-mode-active');
            toggleParentModeUI(); // Update UI immediately
        }

        function toggleParentModeUI() { // Called to sync UI with isParentModeActive
            parentControlsSection.style.display = isParentModeActive ? 'flex' : 'none';
            const deleteButtons = document.querySelectorAll('.delete-chore-btn');
            deleteButtons.forEach(btn => {
                if (btn) btn.style.display = isParentModeActive ? 'block' : 'none';
            });
        }

        pageTitle.addEventListener('mousedown', startPress);
        pageTitle.addEventListener('touchstart', startPress, { passive: false }); 
        pageTitle.addEventListener('mouseup', cancelPress);
        pageTitle.addEventListener('mouseleave', cancelPress); 
        pageTitle.addEventListener('touchend', cancelPress);
        pageTitle.addEventListener('touchcancel', cancelPress); 
        exitParentModeButton.addEventListener('click', deactivateParentMode);

        addChoreButton.addEventListener('click', () => {
            const name = newChoreNameInput.value.trim();
            const iconType = newChoreIconTypeInput.value;
            const iconValue = newChoreIconValueInput.value.trim();
            if (!name || !iconValue) {
                alert("Please enter chore name and icon value."); return;
            }
            if (iconType === 'svg' && !svgIcons[iconValue]) {
                alert(`SVG key "${iconValue}" not recognized. Available keys: ${Object.keys(svgIcons).join(', ')}`); return;
            }
            const newChore = {
                id: name.toLowerCase().replace(/\s+/g, '_') + '_' + Date.now(), 
                name: name, iconType: iconType, iconValue: iconValue
            };
            chores.push(newChore);
            newChoreNameInput.value = ''; newChoreIconValueInput.value = '';
            renderGrid(); // Re-render to show new chore
            saveAllData();
        });

        function deleteChore(choreIdToDelete) {
            const choreDefToDelete = chores.find(c => c.id === choreIdToDelete);
            if (!choreDefToDelete || !confirm(`Are you sure you want to delete the chore "${choreDefToDelete.name}"? This will remove it and its data from ALL weeks.`)) {
                return;
            }

            chores = chores.filter(chore => chore.id !== choreIdToDelete);

            // Remove data for this chore from all weeks in appData
            for (const weekId in appData) {
                if (appData[weekId] && appData[weekId].completionStatus) {
                    let weekModified = false;
                    Object.keys(appData[weekId].completionStatus).forEach(key => {
                        if (key.startsWith(choreIdToDelete + '_')) {
                            delete appData[weekId].completionStatus[key];
                            weekModified = true;
                        }
                    });
                    if (weekModified) {
                        recalculatePointsForWeek(weekId);
                    }
                }
            }
            renderGrid(); // Re-render the current week's grid
            updatePointsDisplay(); // Update points for current week
            saveAllData();
        }
        
        function updateToggleViewButtonText() {
            if (isCurrentRealWeek()) {
                toggleViewButton.disabled = false;
                toggleViewButton.textContent = currentView === 'weekly' ? "Switch to Today's View" : 'Switch to Full Week View';
            } else {
                 // On past/future weeks, "Today's View" shows all 7 days anyway, so effectively it's always "Full Week"
                toggleViewButton.disabled = false; // Or true if you want to disable toggling
                toggleViewButton.textContent = currentView === 'weekly' ? "Switch to Daily (Full Week)" : "Switch to Weekly";
                // A bit clunky, alternative: disable toggle on non-current weeks or always show "Full Week"
            }
        }


        function toggleView() {
            if (currentView === 'weekly') {
                currentView = 'daily';
            } else {
                currentView = 'weekly';
            }
            updateToggleViewButtonText();
            renderGrid(); // Re-render based on new view and current week context
        }
        toggleViewButton.addEventListener('click', toggleView);

        prevWeekButton.addEventListener('click', () => {
            const newStartDate = new Date(currentWeekStartDate);
            newStartDate.setDate(currentWeekStartDate.getDate() - 7);
            navigateToWeek(newStartDate);
        });

        nextWeekButton.addEventListener('click', () => {
            const newStartDate = new Date(currentWeekStartDate);
            newStartDate.setDate(currentWeekStartDate.getDate() + 7);
            navigateToWeek(newStartDate);
        });

        downloadDataButton.addEventListener('click', () => {
            const dataToBackup = {
                choresDefinitions: chores,
                appData: appData,
                lastRewardedPoints: localStorage.getItem('matildaLastRewardedPoints') || '0'
                // Include any other global settings if they exist
            };
            const jsonString = JSON.stringify(dataToBackup, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'matilda_chores_all_data.json';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("All chore data download initiated!");
        });

        uploadDataButton.addEventListener('click', () => { uploadFileInput.click(); });

        uploadFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedFullData = JSON.parse(e.target.result);
                    if (loadedFullData && Array.isArray(loadedFullData.choresDefinitions) && typeof loadedFullData.appData === 'object') {
                        chores = loadedFullData.choresDefinitions;
                        appData = loadedFullData.appData;
                        
                        // Recalculate points for all loaded weeks to ensure consistency if point values changed
                        for (const weekId in appData) {
                            recalculatePointsForWeek(weekId);
                        }

                        if (loadedFullData.lastRewardedPoints) {
                            localStorage.setItem('matildaLastRewardedPoints', loadedFullData.lastRewardedPoints);
                        } else {
                            localStorage.removeItem('matildaLastRewardedPoints');
                        }
                        // Remove all old week-specific reward flags as they might not apply to new data
                        Object.keys(localStorage).forEach(key => {
                             if (key.startsWith(`rewarded_`)) localStorage.removeItem(key);
                        });

                        saveAllData(); 
                        // Navigate to the current real-world week after loading
                        navigateToWeek(getWeekStartDate(new Date())); 
                        alert("All data loaded successfully! Displaying current week.");
                    } else {
                        alert("Invalid data file format. Required fields: choresDefinitions (array), appData (object).");
                    }
                } catch (error) {
                    alert("Error reading or parsing file: " + error.message);
                } finally {
                    uploadFileInput.value = null; 
                }
            };
            reader.readAsText(file);
        });

        resetWeekButton.addEventListener('click', resetCurrentWeekData);
        
        // --- Initialize ---
        initApp();

    </script>
</body>
</html>